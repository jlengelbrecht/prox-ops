---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: lightrag
  namespace: ai
spec:
  chart:
    spec:
      chart: app-template
      # renovate: datasource=helm registryUrl=https://bjw-s.github.io/helm-charts
      version: 4.4.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: ai
  interval: 1h
  values:
    controllers:
      lightrag:
        # Recreate strategy for RWO PVC compatibility
        strategy: Recreate
        containers:
          app:
            image:
              repository: ghcr.io/hkuds/lightrag
              # renovate: datasource=docker depName=ghcr.io/hkuds/lightrag
              tag: v1.4.9.8
            env:
              # Server Configuration
              HOST: "0.0.0.0"
              PORT: "9621"
              WORKERS: "2"
              TIMEOUT: "200"
              LOG_LEVEL: "INFO"

              # Timeout Configuration
              # Increased to handle model loading/swapping in Ollama VRAM
              EMBEDDING_TIMEOUT: "180"
              LLM_TIMEOUT: "180"
              # Log directory - use emptyDir for ephemeral logs (cloud-native pattern)
              LOG_DIR: "/app/logs"

              # Working directories (PVC mounts)
              WORKING_DIR: "/app/data/rag_storage"
              INPUT_DIR: "/app/data/inputs"
              WORKSPACE: "homelab"

              # LLM Configuration (Ollama)
              # Using 32B model per LightRAG recommendation for entity-relationship extraction
              LLM_BINDING: "ollama"
              LLM_MODEL: "qwen2.5:32b-instruct-q4_K_M"
              LLM_BINDING_HOST: "http://ollama.ai.svc.cluster.local:11434"
              OLLAMA_LLM_NUM_CTX: "32768"

              # Embedding Configuration (Ollama)
              EMBEDDING_BINDING: "ollama"
              EMBEDDING_MODEL: "nomic-embed-text"
              EMBEDDING_BINDING_HOST: "http://ollama.ai.svc.cluster.local:11434"
              EMBEDDING_DIM: "768"

              # Storage Configuration
              LIGHTRAG_KV_STORAGE: "JsonKVStorage"
              LIGHTRAG_VECTOR_STORAGE: "QdrantVectorDBStorage"
              LIGHTRAG_GRAPH_STORAGE: "NetworkXStorage"
              LIGHTRAG_DOC_STATUS_STORAGE: "JsonDocStatusStorage"

              # Qdrant Configuration
              QDRANT_URL: "http://qdrant.ai.svc.cluster.local:6333"
              QDRANT_API_KEY:
                valueFrom:
                  secretKeyRef:
                    name: qdrant-secret
                    key: api-key

              # Disable authentication for internal cluster access
              # External auth handled by Authentik forward auth
              LIGHTRAG_API_KEY: ""

            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /health
                    port: &port 9621
                  initialDelaySeconds: 60
                  periodSeconds: 30
                  timeoutSeconds: 10
                  failureThreshold: 3
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /health
                    port: *port
                  initialDelaySeconds: 30
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3
            resources:
              requests:
                cpu: 500m
                memory: 1Gi
              limits:
                cpu: 2
                memory: 4Gi

            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities:
                drop:
                  - ALL

    defaultPodOptions:
      automountServiceAccountToken: false
      nodeSelector:
        # Target AI workloads node
        kubernetes.io/hostname: k8s-work-10
      annotations:
        security.homelab/network: "Internal only - ClusterIP service with Authentik forward auth"
        security.homelab/storage: "Ceph RBD for RAG data persistence"
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile:
          type: RuntimeDefault

    persistence:
      rag:
        enabled: true
        existingClaim: lightrag-rag
        globalMounts:
          - path: /app/data/rag_storage
      input:
        enabled: true
        existingClaim: lightrag-input
        globalMounts:
          - path: /app/data/inputs
      # Ephemeral logs - follows cloud-native pattern (logs to emptyDir, not PVC)
      logs:
        enabled: true
        type: emptyDir
        globalMounts:
          - path: /app/logs

    service:
      app:
        controller: lightrag
        type: ClusterIP
        ports:
          http:
            port: 9621
            protocol: TCP
