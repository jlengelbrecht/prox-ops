---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: searxng
  namespace: ai
spec:
  chart:
    spec:
      chart: searxng
      # renovate: datasource=helm registryUrl=https://charts.searxng.org
      version: 1.0.0
      sourceRef:
        kind: HelmRepository
        name: searxng
        namespace: ai
  interval: 1h
  values:
    # Image configuration
    image:
      repository: searxng/searxng
      pullPolicy: IfNotPresent

    # Environment variables
    env:
      INSTANCE_NAME: "homelab-search"
      BASE_URL: "http://searxng.ai.svc.cluster.local:8080/"
      AUTOCOMPLETE: "false"

    # Service configuration
    service:
      main:
        ports:
          http:
            port: 8080

    # Probes
    probes:
      liveness:
        enabled: true
      readiness:
        enabled: true
      startup:
        enabled: true

    # Ingress - disabled, internal access only
    ingress:
      main:
        enabled: false

    # Persistence - disabled, stateless search
    persistence:
      config:
        enabled: false

    # Resources
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # SearXNG configuration
    searxng:
      # Use secret from ExternalSecret
      existingSecret: searxng-secrets
      secretKey: secret-key

      # SearXNG settings.yaml configuration
      config:
        use_default_settings: true

        # General settings
        general:
          instance_name: "Homelab Search"
          privacypolicy_url: false
          donation_url: false
          contact_url: false
          enable_metrics: false

        # Search settings
        search:
          safe_search: 0
          autocomplete: ""
          default_lang: "en"
          formats:
            - html
            - json  # Required for Firecrawl integration

        # Server settings
        server:
          limiter: true
          image_proxy: false
          # Public instance mode disabled - internal only
          public_instance: false

        # Redis for rate limiting (using Valkey)
        redis:
          url: "redis://valkey.cache.svc.cluster.local:6379/1"

        # UI settings - minimal for API use
        ui:
          static_use_hash: true
          default_theme: simple
          results_on_new_tab: false

        # Enabled search engines
        engines:
          # General search engines
          - name: google
            engine: google
            shortcut: g
            disabled: false

          - name: bing
            engine: bing
            shortcut: b
            disabled: false

          - name: duckduckgo
            engine: duckduckgo
            shortcut: ddg
            disabled: false

          - name: brave
            engine: brave
            shortcut: br
            disabled: false

          # Tech/Documentation
          - name: github
            engine: github
            shortcut: gh
            disabled: false

          - name: stackoverflow
            engine: stackoverflow
            shortcut: so
            disabled: false

          - name: arxiv
            engine: arxiv
            shortcut: arx
            disabled: false

          # Wikipedia
          - name: wikipedia
            engine: wikipedia
            shortcut: w
            disabled: false

    # Pod security context
    podSecurityContext:
      runAsUser: 977
      runAsGroup: 977
      fsGroup: 977
      seccompProfile:
        type: RuntimeDefault

    # Container security context
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      capabilities:
        drop:
          - ALL
