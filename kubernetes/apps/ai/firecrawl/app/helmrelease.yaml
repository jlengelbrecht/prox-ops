---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: firecrawl
  namespace: ai
spec:
  chart:
    spec:
      chart: app-template
      # renovate: datasource=helm registryUrl=https://bjw-s.github.io/helm-charts
      version: 4.4.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: ai
  interval: 1h
  values:
    controllers:
      firecrawl:
        strategy: RollingUpdate
        containers:
          # Main API container
          api:
            image:
              repository: ghcr.io/firecrawl/firecrawl
              # renovate: datasource=docker depName=ghcr.io/firecrawl/firecrawl
              tag: latest@sha256:eddc8e54e17c0e1b7077798968609e1b8741346fd7150ef03f73fbe4f441a22f
            env:
              # Core settings
              PORT: "3002"
              HOST: "0.0.0.0"
              USE_DB_AUTHENTICATION: "true"
              LOGGING_LEVEL: "INFO"

              # PostgreSQL (CloudNative-PG shared cluster)
              POSTGRES_HOST: "postgres-rw.database.svc.cluster.local"
              POSTGRES_PORT: "5432"
              POSTGRES_DB: "firecrawl"
              POSTGRES_USER:
                valueFrom:
                  secretKeyRef:
                    name: firecrawl-secrets
                    key: postgres-user
              POSTGRES_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: firecrawl-secrets
                    key: postgres-password

              # Redis/Valkey (shared cache cluster with authentication)
              REDIS_URL:
                valueFrom:
                  secretKeyRef:
                    name: firecrawl-secrets
                    key: redis-url
              REDIS_RATE_LIMIT_URL:
                valueFrom:
                  secretKeyRef:
                    name: firecrawl-secrets
                    key: redis-rate-limit-url

              # SearXNG integration for /search endpoint
              SEARXNG_ENDPOINT: "http://searxng.ai.svc.cluster.local:8080"

              # Playwright service (sidecar container)
              PLAYWRIGHT_MICROSERVICE_URL: "http://localhost:3000"

              # API Authentication
              TEST_API_KEY:
                valueFrom:
                  secretKeyRef:
                    name: firecrawl-secrets
                    key: api-key

              # Crawl settings
              NUM_WORKERS_PER_QUEUE: "2"
              CRAWL_CONCURRENT_REQUESTS: "5"
              MAX_CONCURRENT_JOBS: "5"
              MAX_CRAWL_DEPTH: "3"
              MAX_PAGES_PER_CRAWL: "50"

              # Optional: LLM extraction via LiteLLM (OpenAI-compatible)
              # Uncomment to enable structured data extraction features
              # OPENAI_BASE_URL: "http://litellm.ai.svc.cluster.local:4000/v1"
              # MODEL_NAME: "ollama/llama3.2"

              # Block media downloads (images, video, CSS, fonts) to reduce bandwidth
              BLOCK_MEDIA: "true"

            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /health
                    port: 3002
                  initialDelaySeconds: 30
                  periodSeconds: 30
                  timeoutSeconds: 10
                  failureThreshold: 3
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /health
                    port: 3002
                  initialDelaySeconds: 15
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3

            resources:
              requests:
                cpu: 500m
                memory: 1Gi
              limits:
                cpu: 2
                memory: 4Gi

            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities:
                drop:
                  - ALL

          # Playwright sidecar for JS-rendered pages
          playwright:
            image:
              repository: ghcr.io/firecrawl/playwright-service
              # renovate: datasource=docker depName=ghcr.io/firecrawl/playwright-service
              tag: latest@sha256:13e165a04a7adaeb11979efb860f751854f86a6082bc3dd966e33555d8bcd011
            env:
              MAX_CONCURRENT_PAGES: "5"
              BLOCK_MEDIA: "true"

            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /health
                    port: 3000
                  initialDelaySeconds: 30
                  periodSeconds: 30
                  timeoutSeconds: 10
                  failureThreshold: 3
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /health
                    port: 3000
                  initialDelaySeconds: 15
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3

            resources:
              requests:
                cpu: 500m
                memory: 1Gi
              limits:
                cpu: 2
                memory: 2Gi

            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities:
                drop:
                  - ALL

    defaultPodOptions:
      automountServiceAccountToken: false
      annotations:
        security.homelab/purpose: "Web crawler and search API for AI platform"
        security.homelab/network: "Internal only - connects to SearXNG, PostgreSQL, Valkey"
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

    service:
      app:
        controller: firecrawl
        type: ClusterIP
        ports:
          http:
            port: 3002
            targetPort: 3002
            protocol: TCP
