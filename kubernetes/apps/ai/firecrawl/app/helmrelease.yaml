---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: firecrawl
  namespace: ai
spec:
  chart:
    spec:
      chart: app-template
      # renovate: datasource=helm registryUrl=https://bjw-s.github.io/helm-charts
      version: 4.4.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: ai
  interval: 1h
  values:
    controllers:
      # API server - handles HTTP requests
      api:
        strategy: RollingUpdate
        containers:
          app:
            image:
              # firecrawl-simple: stripped-down version without Supabase/billing
              repository: trieve/firecrawl
              # renovate: datasource=docker depName=trieve/firecrawl
              tag: v0.0.55
            command: ["pnpm", "run", "start:production"]
            env:
              # Core settings
              PORT: "3002"
              HOST: "0.0.0.0"

              # Redis/Valkey (shared cache cluster with authentication)
              REDIS_URL:
                valueFrom:
                  secretKeyRef:
                    name: firecrawl-secrets
                    key: redis-url
              REDIS_RATE_LIMIT_URL:
                valueFrom:
                  secretKeyRef:
                    name: firecrawl-secrets
                    key: redis-rate-limit-url

              # SearXNG integration for /search endpoint
              SEARXNG_ENDPOINT: "http://searxng.ai.svc.cluster.local:8080"

              # Browser rendering service (trieve/puppeteer-service-ts)
              # Note: Env var name is from upstream firecrawl; actual service is Puppeteer
              PLAYWRIGHT_MICROSERVICE_URL: "http://firecrawl-puppeteer.ai.svc.cluster.local:3000"

              # API Authentication
              TEST_API_KEY:
                valueFrom:
                  secretKeyRef:
                    name: firecrawl-secrets
                    key: api-key

              # Performance tuning
              NUM_WORKERS_PER_QUEUE: "2"
              # Bull admin panel: To enable, add BULL_AUTH_KEY secret to firecrawl-secrets
              # and reference it here. Panel available at /admin/@/queues

            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /health
                    port: 3002
                  initialDelaySeconds: 30
                  periodSeconds: 30
                  timeoutSeconds: 10
                  failureThreshold: 3
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /health
                    port: 3002
                  initialDelaySeconds: 15
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3

            resources:
              requests:
                cpu: 200m
                memory: 512Mi
              limits:
                cpu: 1
                memory: 1Gi

            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities:
                drop:
                  - ALL

      # Worker - processes crawl jobs from Redis queue
      worker:
        strategy: RollingUpdate
        containers:
          app:
            image:
              repository: trieve/firecrawl
              # renovate: datasource=docker depName=trieve/firecrawl
              tag: v0.0.55
            command: ["pnpm", "run", "worker:production"]
            env:
              # Redis/Valkey (shared cache cluster with authentication)
              REDIS_URL:
                valueFrom:
                  secretKeyRef:
                    name: firecrawl-secrets
                    key: redis-url
              REDIS_RATE_LIMIT_URL:
                valueFrom:
                  secretKeyRef:
                    name: firecrawl-secrets
                    key: redis-rate-limit-url

              # Browser rendering service (trieve/puppeteer-service-ts)
              # Note: Env var name is from upstream firecrawl; actual service is Puppeteer
              PLAYWRIGHT_MICROSERVICE_URL: "http://firecrawl-puppeteer.ai.svc.cluster.local:3000"

              # Performance tuning
              NUM_WORKERS_PER_QUEUE: "2"

            resources:
              requests:
                cpu: 200m
                memory: 512Mi
              limits:
                cpu: 1
                memory: 1Gi

            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities:
                drop:
                  - ALL

      # Puppeteer service for JS-rendered pages
      puppeteer:
        strategy: RollingUpdate
        containers:
          app:
            image:
              repository: trieve/puppeteer-service-ts
              # renovate: datasource=docker depName=trieve/puppeteer-service-ts
              tag: v0.0.6
            env:
              PORT: "3000"
              MAX_CONCURRENT_PAGES: "5"

            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /health
                    port: 3000
                  initialDelaySeconds: 30
                  periodSeconds: 30
                  timeoutSeconds: 10
                  failureThreshold: 3
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /health
                    port: 3000
                  initialDelaySeconds: 15
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3

            resources:
              requests:
                cpu: 200m
                memory: 512Mi
              limits:
                cpu: 1
                memory: 1Gi

            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities:
                drop:
                  - ALL

    defaultPodOptions:
      automountServiceAccountToken: false
      annotations:
        security.homelab/purpose: "Web crawler and search API for AI platform"
        security.homelab/network: "Internal only - connects to SearXNG, Valkey"
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

    service:
      # Main API service
      api:
        controller: api
        type: ClusterIP
        ports:
          http:
            port: 3002
            targetPort: 3002
            protocol: TCP
      # Puppeteer browser service (internal)
      puppeteer:
        controller: puppeteer
        type: ClusterIP
        ports:
          http:
            port: 3000
            targetPort: 3000
            protocol: TCP
