---
# STORY-031-4: External HTTPRoute for Twilio Webhooks
# Voice bridge accessible from Twilio for WebSocket connections
# Uses envoy-external for Cloudflare Tunnel access
#
# Security:
# - /ws and /twiml: Twilio-only (signature validated in code)
# - /health: Public (for monitoring)
# - /api: NOT EXPOSED externally (removed for security)
#
# The /api endpoints require API key authentication and should only
# be accessed internally or via port-forward for manual testing.
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: voice-bridge-external
  namespace: ai
  annotations:
    external-dns.alpha.kubernetes.io/hostname: voice-bridge.homelab0.org
spec:
  parentRefs:
    - name: envoy-external
      namespace: network
      sectionName: https
  hostnames:
    - voice-bridge.homelab0.org
  rules:
    # WebSocket endpoint for Twilio Media Streams
    # Security: call_id is cryptographically random UUID
    - matches:
        - path:
            type: PathPrefix
            value: /ws
      backendRefs:
        - name: voice-bridge
          port: 8080
    # TwiML webhook endpoint for inbound calls
    # Security: Twilio signature validation in application code
    - matches:
        - path:
            type: PathPrefix
            value: /twiml
      backendRefs:
        - name: voice-bridge
          port: 8080
    # Health check (public for external monitoring)
    - matches:
        - path:
            type: Exact
            value: /health
      backendRefs:
        - name: voice-bridge
          port: 8080
    # NOTE: /api endpoints intentionally NOT exposed externally
    # Access via: kubectl port-forward -n ai svc/voice-bridge 8080:8080
