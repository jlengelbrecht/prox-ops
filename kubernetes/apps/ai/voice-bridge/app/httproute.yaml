---
# STORY-031-4: External HTTPRoute for Twilio Media Streams
# Voice bridge accessible from Twilio for OUTBOUND call audio streaming
# Uses envoy-external for Cloudflare Tunnel access
#
# OUTBOUND-ONLY ARCHITECTURE:
# - Moltbot → voice-bridge (internal) → Twilio API → Phone
# - Twilio → voice-bridge /ws (external) → Audio streaming back
#
# Security:
# - /ws: Twilio Media Streams only (call_id is cryptographic UUID)
# - /health: Public (for monitoring, no sensitive data)
# - /api: NOT EXPOSED (internal service-to-service only)
# - /twiml: NOT EXPOSED (only needed for inbound calls, which we don't use)
#
# The /api endpoints require API key authentication and should only
# be accessed internally via k8s service or port-forward for testing.
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: voice-bridge-external
  namespace: ai
  annotations:
    external-dns.alpha.kubernetes.io/hostname: voice-bridge.homelab0.org
spec:
  parentRefs:
    - name: envoy-external
      namespace: network
      sectionName: https
  hostnames:
    - voice-bridge.homelab0.org
  rules:
    # WebSocket endpoint for Twilio Media Streams (OUTBOUND CALLS)
    # When voice-bridge initiates a call, Twilio connects back here for audio
    # Security: call_id is cryptographically random UUID (128-bit entropy)
    - matches:
        - path:
            type: PathPrefix
            value: /ws
      backendRefs:
        - name: voice-bridge
          port: 8080
    # Health check (public for external monitoring)
    # Returns: status, timestamp, active call count (no sensitive data)
    - matches:
        - path:
            type: Exact
            value: /health
      backendRefs:
        - name: voice-bridge
          port: 8080
    # NOT EXPOSED (internal only):
    # - /api/* - Call initiation (Moltbot calls via k8s service)
    # - /twiml/* - Inbound call handling (not used, outbound only)
