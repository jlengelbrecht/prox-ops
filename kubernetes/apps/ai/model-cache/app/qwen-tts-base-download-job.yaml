---
# EPIC-030: Qwen TTS Base Model Pre-download Job
# Downloads Qwen3-TTS-Base model for voice cloning to shared cache PVC
#
# Model: Qwen/Qwen3-TTS-12Hz-1.7B-Base (~4GB disk, ~5GB VRAM)
# Purpose: Voice cloning with ref_audio - create custom voices from samples
#
# Usage:
#   kubectl apply -f qwen-tts-base-download-job.yaml
#   kubectl logs -n ai job/qwen-tts-base-download -f
#
# After download, verify:
#   kubectl exec -it -n ai -- ls -la /models/Qwen/Qwen3-TTS-12Hz-1.7B-Base/
#
# Note: Job immutability - to re-run, delete first:
#   kubectl delete job -n ai qwen-tts-base-download
apiVersion: batch/v1
kind: Job
metadata:
  name: qwen-tts-base-download
  namespace: ai
  labels:
    app.kubernetes.io/name: qwen-tts-base-download
    app.kubernetes.io/component: cache-loader
    app.kubernetes.io/part-of: kserve
    epic: "030"
spec:
  # Allow 3 retries in case of network failures
  backoffLimit: 3
  # NOTE: ttlSecondsAfterFinished intentionally omitted (see model-predownload-job.yaml)
  template:
    metadata:
      labels:
        app.kubernetes.io/name: qwen-tts-base-download
        app.kubernetes.io/component: cache-loader
    spec:
      restartPolicy: Never
      automountServiceAccountToken: false

      # Fix PVC permissions for non-root user
      # Note: initContainer MUST run as root (UID 0) to chown files - this is intentional
      initContainers:
        - name: fix-permissions
          image: busybox:1.37
          command:
            - sh
            - -c
            - |
              mkdir -p /models/Qwen /models/.cache
              chown -R 1000:1000 /models/Qwen /models/.cache
              echo "Permissions fixed: /models/Qwen and /models/.cache owned by user 1000"
          volumeMounts:
            - name: model-cache
              mountPath: /models
          securityContext:
            runAsUser: 0  # Required for chown operation
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
              add: ["CHOWN"]
            seccompProfile:
              type: RuntimeDefault
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 100m
              memory: 64Mi

      containers:
        - name: huggingface-downloader
          image: python:3.11-slim
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault

          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail

              echo "Installing huggingface-hub CLI..."
              pip install --no-cache-dir 'huggingface-hub[cli]>=0.27,<0.28'
              export PATH="/tmp/.local/bin:$PATH"

              echo ""
              echo "=== EPIC-030: Qwen TTS Base Model Download ==="
              echo "Downloading Qwen3-TTS-Base for voice cloning capability"
              echo ""

              # Download Qwen3-TTS-12Hz-1.7B-Base (~4GB)
              echo "=== Downloading Qwen/Qwen3-TTS-12Hz-1.7B-Base (~4GB) ==="
              huggingface-cli download \
                Qwen/Qwen3-TTS-12Hz-1.7B-Base \
                --local-dir /models/Qwen/Qwen3-TTS-12Hz-1.7B-Base \
                --local-dir-use-symlinks False
              echo "Download complete: Qwen/Qwen3-TTS-12Hz-1.7B-Base"
              echo ""

              # Verify download
              echo "=== Verifying download ==="
              ls -la /models/Qwen/Qwen3-TTS-12Hz-1.7B-Base/
              du -sh /models/Qwen/Qwen3-TTS-12Hz-1.7B-Base/
              echo ""

              echo "=== Qwen TTS Base model download complete ==="
              echo "Model: Qwen/Qwen3-TTS-12Hz-1.7B-Base"
              echo "Location: /models/Qwen/Qwen3-TTS-12Hz-1.7B-Base/"
              echo "VRAM: ~5GB (FP16)"
              echo "Use case: Voice cloning with ref_audio parameter"
              echo ""
              echo "API Usage:"
              echo "  - Endpoint: /v1/audio/speech"
              echo "  - Provide ref_audio with base64-encoded voice sample"
              echo "  - Model creates custom voice from reference audio"
              echo ""
              echo "Next steps:"
              echo "  1. Deploy qwen-tts-base InferenceService"
              echo "  2. Configure LiteLLM for TTS routing"

          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2
              memory: 2Gi

          volumeMounts:
            - name: model-cache
              mountPath: /models

          env:
            - name: HF_TOKEN
              valueFrom:
                secretKeyRef:
                  name: huggingface-token
                  key: HF_TOKEN
                  optional: true  # TTS models are not gated
            - name: HOME
              value: /tmp
            - name: HF_HOME
              value: /models/.cache
            - name: HF_HUB_DISABLE_TELEMETRY
              value: "1"

      volumes:
        - name: model-cache
          persistentVolumeClaim:
            claimName: model-cache
