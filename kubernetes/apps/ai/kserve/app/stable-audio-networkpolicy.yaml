---
# CiliumNetworkPolicy for Stable-Audio InferenceService
# Implements zero-trust network segmentation
# STORY-142 Phase 3: Security hardening per security-guardian recommendations
#
# Security Posture:
# - Ingress: ONLY from envoy-internal gateway (HTTPRoute traffic)
# - Egress: DNS resolution only (model already cached, no internet needed)
# - Default: DENY all other traffic
#
# Rationale:
# - Prevents lateral movement if vLLM-Omni container compromised
# - stable-audio-open-1.0 pre-cached in model-cache PVC
# - vLLM-Omni runs in offline mode (HF_HUB_OFFLINE=1), no internet access needed
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: stable-audio
  namespace: ai
  labels:
    app.kubernetes.io/name: stable-audio
    app.kubernetes.io/component: networkpolicy
spec:
  # Target KServe InferenceService pods
  endpointSelector:
    matchLabels:
      serving.kserve.io/inferenceservice: stable-audio

  # Ingress Rules
  ingress:
    # Allow traffic from envoy-internal gateway (HTTPRoute ingress)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: network
            app.kubernetes.io/name: envoy-gateway
            app.kubernetes.io/component: envoy-gateway
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

    # Allow Knative Serving activator (cold start requests)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: knative-serving
            app: activator
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

    # Allow Knative Serving autoscaler (metrics scraping)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: knative-serving
            app: autoscaler
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

    # Allow Prometheus scraping (observability)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: observability
            app.kubernetes.io/name: prometheus
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

  # Egress Rules
  egress:
    # Allow DNS resolution ONLY (required for internal cluster communication)
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP
          rules:
            dns:
              - matchPattern: "*"
