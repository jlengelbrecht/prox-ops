---
# CiliumNetworkPolicy for Qwen-Coder InferenceService
# Implements zero-trust network segmentation
# STORY-140: Security hardening per security-guardian recommendations
#
# Security Posture:
# - Ingress: ONLY from envoy-internal gateway (HTTPRoute traffic)
# - Egress: DNS resolution only (model already cached, no internet needed)
# - Default: DENY all other traffic
#
# Rationale:
# - Prevents lateral movement if vLLM container compromised
# - Qwen2.5-Coder-7B-Instruct pre-cached (no HuggingFace download needed)
# - No legitimate need for internet access during inference
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: qwen-coder
  namespace: ai
  labels:
    app.kubernetes.io/name: qwen-coder
    app.kubernetes.io/component: networkpolicy
spec:
  # Target KServe InferenceService pods
  # Note: KServe creates pods with serving.kserve.io/inferenceservice label
  endpointSelector:
    matchLabels:
      serving.kserve.io/inferenceservice: qwen-coder

  # Ingress Rules
  ingress:
    # Allow traffic from envoy-internal gateway (HTTPRoute ingress)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: network
            app.kubernetes.io/name: envoy-gateway
            app.kubernetes.io/component: envoy-gateway
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

    # Allow Knative Serving activator (cold start requests)
    # During scale-from-zero, activator forwards requests to predictor
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: knative-serving
            app: activator
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

    # Allow Knative Serving autoscaler (metrics scraping)
    # Autoscaler needs to scrape metrics for scaling decisions
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: knative-serving
            app: autoscaler
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

    # Allow Prometheus scraping (observability)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: observability
            app.kubernetes.io/name: prometheus
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

  # Egress Rules
  egress:
    # Allow DNS resolution (required for internal cluster communication)
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP
          rules:
            dns:
              - matchPattern: "*"

    # Block all other egress
    # Model already cached in model-cache PVC (no HuggingFace download needed)
    # If HuggingFace download is required at runtime, add:
    # - toFQDNs:
    #     - matchName: huggingface.co
    #     - matchName: cdn.lfs.github.com
    #   toPorts:
    #     - ports:
    #         - port: "443"
    #           protocol: TCP
