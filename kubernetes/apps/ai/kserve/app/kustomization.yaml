---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  # renovate: datasource=github-releases depName=kserve/kserve
  # KServe CRDs and core components (controller, webhook)
  # Version: v0.13.1 (latest stable)
  # Note: Installing in serverless mode with Knative Serving integration
  - https://github.com/kserve/kserve/releases/download/v0.13.1/kserve.yaml
  # KServe cluster resources (ClusterServingRuntimes for various frameworks)
  - https://github.com/kserve/kserve/releases/download/v0.13.1/kserve-cluster-resources.yaml

# Note: KServe controller installs in kserve namespace by default
# InferenceServices can be created in any namespace (e.g., ai)

# Disable hash suffix for ConfigMaps so KServe can find them by name
generatorOptions:
  disableNameSuffixHash: true

# Configure KServe for serverless (Knative) mode
configMapGenerator:
  - name: inferenceservice-config
    namespace: kserve
    behavior: merge
    literals:
      # Enable serverless deployment mode (uses Knative)
      - deploy={"defaultDeploymentMode":"Serverless"}
      # Configure storage initializer for model downloads
      - storageInitializer={"image":"kserve/storage-initializer:v0.13.1","memoryRequest":"100Mi","memoryLimit":"1Gi","cpuRequest":"100m","cpuLimit":"1"}
      # Configure ingress (uses Kourier from Knative, not Istio)
      - ingress={"ingressClassName":"kourier.ingress.networking.knative.dev","ingressDomain":"svc.cluster.local","domainTemplate":"{{.Name}}.{{.Namespace}}.svc.cluster.local","urlScheme":"http","disableIstioVirtualHost":true}

patches:
  # Add resource limits to controller manager
  - target:
      kind: Deployment
      name: kserve-controller-manager
      namespace: kserve
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
