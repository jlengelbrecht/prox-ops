---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gatus
  namespace: media
spec:
  chart:
    spec:
      chart: gatus
      version: 1.4.4
      sourceRef:
        kind: HelmRepository
        name: twin
        namespace: media
  interval: 1h
  values:
    image:
      repository: twinproduction/gatus
      tag: v5.27.2

    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        memory: 256Mi

    env:
      OIDC_CLIENT_ID:
        valueFrom:
          secretKeyRef:
            name: gatus-oidc-secret
            key: OIDC_CLIENT_ID
      OIDC_CLIENT_SECRET:
        valueFrom:
          secretKeyRef:
            name: gatus-oidc-secret
            key: OIDC_CLIENT_SECRET

    # Inline config - Gatus supports ${VAR} env substitution
    config:
      web:
        port: 8080

      security:
        oidc:
          # Use internal service for OIDC discovery to avoid external network dependency
          issuer-url: http://authentik-server.security.svc.cluster.local/application/o/gatus-health-dashboard/
          redirect-url: https://gatus.homelab0.org/authorization-code/callback
          client-id: ${OIDC_CLIENT_ID}
          client-secret: ${OIDC_CLIENT_SECRET}
          scopes:
            - openid
            - email
            - profile

      storage:
        type: sqlite
        path: /data/gatus.db

      ui:
        title: "Media Stack Status"
        description: "Health monitoring for Plex and media automation services"
        header: "Homelab.0 Media Status"

      endpoints:
        # === MEDIA SERVER ===
        - name: Plex
          group: Media
          url: "http://plex.media.svc.cluster.local:32400/identity"
          interval: 60s
          conditions:
            - "[STATUS] == 200"
            - "[RESPONSE_TIME] < 5000"

        # === ARR STACK ===
        - name: Sonarr
          group: Arr Stack
          url: "http://sonarr.media.svc.cluster.local:8989/ping"
          interval: 60s
          conditions:
            - "[STATUS] == 200"

        - name: Radarr
          group: Arr Stack
          url: "http://radarr.media.svc.cluster.local:7878/ping"
          interval: 60s
          conditions:
            - "[STATUS] == 200"

        - name: Prowlarr
          group: Arr Stack
          url: "http://prowlarr.media.svc.cluster.local:9696/ping"
          interval: 60s
          conditions:
            - "[STATUS] == 200"

        # === REQUEST MANAGEMENT ===
        - name: Overseerr
          group: Requests
          url: "http://overseerr.media.svc.cluster.local:5055/api/v1/status"
          interval: 60s
          conditions:
            - "[STATUS] == 200"

        - name: Wizarr
          group: Requests
          url: "http://wizarr.media.svc.cluster.local:5690/api/health"
          interval: 60s
          conditions:
            - "[STATUS] == 200"

        # === DOWNLOAD CLIENTS ===
        - name: qBittorrent
          group: Downloads
          url: "http://qbittorrent.downloads.svc.cluster.local:8080/api/v2/app/version"
          interval: 60s
          conditions:
            - "[STATUS] == 200"

        - name: SABnzbd
          group: Downloads
          url: "http://sabnzbd.downloads.svc.cluster.local:8080/api?mode=version&output=json"
          interval: 60s
          conditions:
            - "[STATUS] == 200"

        # === MONITORING ===
        - name: Tautulli
          group: Monitoring
          url: "http://tautulli.media.svc.cluster.local:8181/status"
          interval: 60s
          conditions:
            - "[STATUS] == 200"

        - name: Notifiarr
          group: Monitoring
          url: "http://notifiarr.media.svc.cluster.local:5454/api/version"
          interval: 60s
          conditions:
            - "[STATUS] == 200"

        # === AUTOMATION ===
        - name: Maintainerr
          group: Automation
          url: "http://maintainerr.media.svc.cluster.local:6246/api/app/status"
          interval: 60s
          conditions:
            - "[STATUS] == 200"

        - name: Huntarr
          group: Automation
          url: "http://huntarr.media.svc.cluster.local:9705/api/health"
          interval: 60s
          conditions:
            - "[STATUS] == 200"

        - name: Cleanuparr
          group: Automation
          url: "http://cleanuparr.media.svc.cluster.local:11011/health"
          interval: 60s
          conditions:
            - "[STATUS] == 200"

    persistence:
      enabled: true
      storageClassName: ceph-block
      size: 1Gi
      accessModes:
        - ReadWriteOnce

    serviceMonitor:
      enabled: true

    # Disable probes - TwiN chart doesn't support custom probe parameters
    # OIDC initialization can delay web server startup beyond default probe limits
    livenessProbe:
      enabled: false

    readinessProbe:
      enabled: false

    podSecurityContext:
      runAsUser: 65534
      runAsGroup: 65534
      fsGroup: 65534
      seccompProfile:
        type: RuntimeDefault

    securityContext:
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL
