---
# Uptime Kuma - Public status page for media stack
# Monitors configured via UI after deployment
# Public access - no authentication required (Status Page feature)
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: uptime-kuma
  namespace: media
spec:
  chart:
    spec:
      chart: uptime-kuma
      version: 2.22.0
      sourceRef:
        kind: HelmRepository
        name: uptime-kuma
        namespace: media
  interval: 1h
  values:
    image:
      repository: louislam/uptime-kuma
      tag: 1.23.16

    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # Uptime Kuma listens on port 3001
    service:
      port: 3001

    volume:
      enabled: true
      storageClassName: ceph-block
      size: 2Gi

    # Pod security - let container use default user (node:1000)
    # fsGroup ensures volume is writable, seccomp provides syscall filtering
    podSecurityContext:
      fsGroup: 1000
      seccompProfile:
        type: RuntimeDefault

    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
        add:
          - SETUID
          - SETGID

    # Liveness/readiness probes
    livenessProbe:
      enabled: true
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

    readinessProbe:
      enabled: true
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
