---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: plex-dmz-isolation
  namespace: media
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: plex
  ingress:
    # Legacy 'fromEntities: world' removed - external access is solely via WireGuard tunnel
    # See fromCIDR: 10.200.200.0/24 rule below for VPS traffic
    # Allow ingress from envoy-internal Gateway for internal access (plex.homelab0.org)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: network
            gateway.envoyproxy.io/owning-gateway-name: envoy-internal
      toPorts:
        - ports:
            - port: "32400"
              protocol: TCP
    # Allow ingress from WireGuard gateway for OCI VPN proxy
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: network
            app.kubernetes.io/name: wireguard-gateway
      toPorts:
        - ports:
            - port: "32400"
              protocol: TCP
    # Allow ingress from WireGuard tunnel network (forwarded VPS traffic)
    - fromCIDR:
        - 10.200.200.0/24
      toPorts:
        - ports:
            - port: "32400"
              protocol: TCP
    # Allow ingress from LAN for local device access (TVs, etc.)
    # TODO: Investigate why TV isn't using envoy-internal path
    - fromCIDR:
        - 10.20.65.0/24
      toPorts:
        - ports:
            - port: "32400"
              protocol: TCP
    # Allow DNS queries
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-dns
    # Allow Prometheus metrics scraping
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: monitoring
            app.kubernetes.io/name: prometheus
    # Allow from Overseerr (library sync, user auth)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: media
            app.kubernetes.io/name: overseerr
      toPorts:
        - ports:
            - port: "32400"
              protocol: TCP
    # Allow from Wizarr (user management)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: media
            app.kubernetes.io/name: wizarr
      toPorts:
        - ports:
            - port: "32400"
              protocol: TCP
    # Allow from Maintainerr (library maintenance)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: media
            app.kubernetes.io/name: maintainerr
      toPorts:
        - ports:
            - port: "32400"
              protocol: TCP
    # Allow from Tautulli (Plex monitoring)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: media
            app.kubernetes.io/name: tautulli
      toPorts:
        - ports:
            - port: "32400"
              protocol: TCP
    # Allow from Notifiarr (notifications and TRaSH sync)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: media
            app.kubernetes.io/name: notifiarr
      toPorts:
        - ports:
            - port: "32400"
              protocol: TCP
    # Allow from Cleanuparr (library integration)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: media
            app.kubernetes.io/name: cleanuparr
      toPorts:
        - ports:
            - port: "32400"
              protocol: TCP
    # Allow from Uptime Kuma (health monitoring)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: media
            app.kubernetes.io/name: uptime-kuma
      toPorts:
        - ports:
            - port: "32400"
              protocol: TCP
    # Allow from Homepage dashboard (widget API access)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: tools
            app.kubernetes.io/name: homepage
      toPorts:
        - ports:
            - port: "32400"
              protocol: TCP
  egress:
    # Allow DNS queries (required for FQDN resolution)
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP
            - port: "53"
              protocol: TCP
    # Allow internet egress for Plex services (authentication, metadata, updates)
    # Using toEntities:world instead of toFQDNs because Cilium FQDN policy requires
    # DNS proxy interception which has complex setup requirements in some configurations
    - toEntities:
        - world
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
            - port: "80"
              protocol: TCP
    # Allow NFS server access (read-write media library)
    - toCIDR:
        - 10.20.66.11/32
      toPorts:
        - ports:
            - port: "2049"
              protocol: TCP
