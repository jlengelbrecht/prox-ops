---
# ExternalSecret for AlertManager Configuration with Discord Webhooks
# Fetches Discord webhook URLs from 1Password and generates full AlertManager config
#
# Setup in 1Password:
# 1. Create a new Login item called "alertmanager_discord"
# 2. Add custom fields for each webhook URL you want to use:
#    - critical_webhook: https://discord.com/api/webhooks/ID/TOKEN (for critical alerts)
#    - security_webhook: https://discord.com/api/webhooks/ID/TOKEN (for security alerts)
#    - general_webhook: https://discord.com/api/webhooks/ID/TOKEN (for all other alerts)
#
# Note: You can use the same webhook URL for all three if you want all alerts in one channel
#
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: alertmanager-config
  namespace: observability
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: onepassword-connect
    kind: ClusterSecretStore
  target:
    name: alertmanager-kube-prometheus-stack-alertmanager
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        alertmanager.yaml: |
          global:
            resolve_timeout: 5m

          # Inhibition rules - prevent alert spam
          inhibit_rules:
            - source_matchers:
                - severity = "critical"
              target_matchers:
                - severity = "warning"
              equal:
                - namespace
                - alertname
            - source_matchers:
                - severity =~ "warning|critical"
              target_matchers:
                - severity = "info"
              equal:
                - namespace
                - alertname
            - source_matchers:
                - alertname = "NodeDown"
              target_matchers:
                - alertname =~ "Node.*"
              equal:
                - node

          # Routing tree
          route:
            receiver: 'default'
            group_by:
              - alertname
              - namespace
              - severity
            group_wait: 30s
            group_interval: 5m
            repeat_interval: 4h

            routes:
              # Critical alerts - immediate notification
              - matchers:
                  - severity = "critical"
                receiver: 'critical-alerts'
                group_wait: 10s
                group_interval: 2m
                repeat_interval: 1h
                continue: false

              # High severity alerts
              - matchers:
                  - severity = "high"
                receiver: 'high-alerts'
                group_wait: 30s
                group_interval: 5m
                repeat_interval: 2h
                continue: false

              # Security alerts (Tetragon)
              - matchers:
                  - alertname =~ ".*Tetragon.*|.*Security.*"
                receiver: 'security-alerts'
                group_wait: 30s
                group_interval: 5m
                repeat_interval: 2h
                continue: false

              # GPU alerts
              - matchers:
                  - alertname =~ ".*GPU.*"
                receiver: 'general-alerts'
                group_wait: 1m
                group_interval: 10m
                repeat_interval: 4h
                continue: false

              # Storage alerts (Ceph)
              - matchers:
                  - alertname =~ ".*Ceph.*|.*Storage.*"
                receiver: 'general-alerts'
                group_wait: 1m
                group_interval: 10m
                repeat_interval: 4h
                continue: false

              # DMZ namespace (Plex)
              - matchers:
                  - namespace = "media"
                receiver: 'general-alerts'
                group_wait: 1m
                group_interval: 10m
                repeat_interval: 4h
                continue: false

              # IoT namespace (Home Assistant)
              - matchers:
                  - namespace = "iot"
                receiver: 'general-alerts'
                group_wait: 1m
                group_interval: 10m
                repeat_interval: 4h
                continue: false

              # Warning alerts
              - matchers:
                  - severity = "warning"
                receiver: 'general-alerts'
                group_wait: 2m
                group_interval: 15m
                repeat_interval: 6h
                continue: false

              # Info alerts (low priority)
              - matchers:
                  - severity = "info"
                receiver: 'info-alerts'
                group_wait: 5m
                group_interval: 30m
                repeat_interval: 12h
                continue: false

          # Receivers configuration with Discord webhooks from 1Password
          receivers:
            - name: 'default'
              # No notifications for default receiver

            - name: 'critical-alerts'
              webhook_configs:
                - url: '{{ .critical_webhook }}'
                  send_resolved: true
                  http_config:
                    follow_redirects: true
                  max_alerts: 10

            - name: 'security-alerts'
              webhook_configs:
                - url: '{{ .security_webhook }}'
                  send_resolved: true
                  http_config:
                    follow_redirects: true
                  max_alerts: 10

            - name: 'general-alerts'
              webhook_configs:
                - url: '{{ .general_webhook }}'
                  send_resolved: true
                  http_config:
                    follow_redirects: true
                  max_alerts: 10

            - name: 'high-alerts'
              webhook_configs:
                - url: '{{ .general_webhook }}'
                  send_resolved: true

            - name: 'info-alerts'
              webhook_configs:
                - url: '{{ .general_webhook }}'
                  send_resolved: false

          templates: []

  data:
    - secretKey: critical_webhook
      remoteRef:
        key: alertmanager_discord
        property: critical_webhook
    - secretKey: security_webhook
      remoteRef:
        key: alertmanager_discord
        property: security_webhook
    - secretKey: general_webhook
      remoteRef:
        key: alertmanager_discord
        property: general_webhook

