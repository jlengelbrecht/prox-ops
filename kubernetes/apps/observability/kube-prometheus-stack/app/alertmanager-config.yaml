---
# AlertManager Configuration Secret
# This configures notification routing and receivers
# User needs to provide Discord webhook URLs
#
# How to create Discord webhooks:
# 1. Go to your Discord server
# 2. Right-click a channel → Edit Channel → Integrations → Webhooks
# 3. Click "New Webhook" or "Create Webhook"
# 4. Copy the webhook URL
# 5. Replace DISCORD_WEBHOOK_URL placeholders below with your webhook URLs
#
# You can use:
# - One webhook for all alerts (simple)
# - Different webhooks for different channels (organized)
# - Multiple webhooks per receiver (redundancy)
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-kube-prometheus-stack-alertmanager
  namespace: observability
type: Opaque
stringData:
  alertmanager.yaml: |
    global:
      resolve_timeout: 5m

    # Inhibition rules - prevent alert spam
    inhibit_rules:
      # Inhibit warning alerts if critical alert is firing for same resource
      - source_matchers:
          - severity = "critical"
        target_matchers:
          - severity = "warning"
        equal:
          - namespace
          - alertname

      # Inhibit info alerts if warning or critical is firing
      - source_matchers:
          - severity =~ "warning|critical"
        target_matchers:
          - severity = "info"
        equal:
          - namespace
          - alertname

      # Inhibit node alerts if node is known to be down
      - source_matchers:
          - alertname = "NodeDown"
        target_matchers:
          - alertname =~ "Node.*"
        equal:
          - node

    # Routing tree
    route:
      # Default receiver for all alerts
      receiver: 'default'

      # Group alerts by these labels to reduce notification noise
      group_by:
        - alertname
        - namespace
        - severity

      # Wait time before sending initial notification
      group_wait: 30s

      # Wait time before sending notifications about new alerts in existing group
      group_interval: 5m

      # Wait time before re-sending notification if alert is still firing
      repeat_interval: 4h

      # Child routes for specific alert types
      routes:
        # Critical alerts - immediate notification, short grouping
        - matchers:
            - severity = "critical"
          receiver: 'critical-alerts'
          group_wait: 10s
          group_interval: 2m
          repeat_interval: 1h
          continue: false

        # High severity alerts
        - matchers:
            - severity = "high"
          receiver: 'high-alerts'
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 2h
          continue: false

        # Security alerts (Tetragon)
        - matchers:
            - alertname =~ ".*Tetragon.*|.*Security.*"
          receiver: 'security-alerts'
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 2h
          continue: false

        # GPU alerts
        - matchers:
            - alertname =~ ".*GPU.*"
          receiver: 'gpu-alerts'
          group_wait: 1m
          group_interval: 10m
          repeat_interval: 4h
          continue: false

        # Storage alerts (Ceph)
        - matchers:
            - alertname =~ ".*Ceph.*|.*Storage.*"
          receiver: 'storage-alerts'
          group_wait: 1m
          group_interval: 10m
          repeat_interval: 4h
          continue: false

        # DMZ namespace (Plex) alerts
        - matchers:
            - namespace = "media"
          receiver: 'dmz-alerts'
          group_wait: 1m
          group_interval: 10m
          repeat_interval: 4h
          continue: false

        # IoT namespace (Home Assistant) alerts
        - matchers:
            - namespace = "iot"
          receiver: 'iot-alerts'
          group_wait: 1m
          group_interval: 10m
          repeat_interval: 4h
          continue: false

        # Warning alerts
        - matchers:
            - severity = "warning"
          receiver: 'warning-alerts'
          group_wait: 2m
          group_interval: 15m
          repeat_interval: 6h
          continue: false

        # Info alerts (low priority)
        - matchers:
            - severity = "info"
          receiver: 'info-alerts'
          group_wait: 5m
          group_interval: 30m
          repeat_interval: 12h
          continue: false

    # Receivers configuration
    receivers:
      # Default receiver - logs only (no notifications)
      - name: 'default'
        # PLACEHOLDER: Add webhook_configs here if you want default notifications
        # Example:
        # webhook_configs:
        #   - url: 'http://localhost:9093'

      # Critical alerts receiver
      - name: 'critical-alerts'
        # PLACEHOLDER: Configure Discord webhook
        # Uncomment and replace DISCORD_WEBHOOK_URL with your webhook:
        # webhook_configs:
        #   - url: 'https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN'
        #     send_resolved: true
        #     http_config:
        #       follow_redirects: true
        #     max_alerts: 10

      # High severity alerts
      - name: 'high-alerts'
        # PLACEHOLDER: Configure Discord webhook
        # webhook_configs:
        #   - url: 'https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN'
        #     send_resolved: true

      # Security alerts (Tetragon)
      - name: 'security-alerts'
        # PLACEHOLDER: Configure Discord webhook
        # Recommended: Use dedicated #security channel
        # webhook_configs:
        #   - url: 'https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN'
        #     send_resolved: true

      # GPU alerts
      - name: 'gpu-alerts'
        # PLACEHOLDER: Configure Discord webhook
        # webhook_configs:
        #   - url: 'https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN'
        #     send_resolved: true

      # Storage alerts (Ceph)
      - name: 'storage-alerts'
        # PLACEHOLDER: Configure Discord webhook
        # webhook_configs:
        #   - url: 'https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN'
        #     send_resolved: true

      # DMZ (Plex) alerts
      - name: 'dmz-alerts'
        # PLACEHOLDER: Configure Discord webhook
        # webhook_configs:
        #   - url: 'https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN'
        #     send_resolved: true

      # IoT (Home Assistant) alerts
      - name: 'iot-alerts'
        # PLACEHOLDER: Configure Discord webhook
        # webhook_configs:
        #   - url: 'https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN'
        #     send_resolved: true

      # Warning alerts
      - name: 'warning-alerts'
        # PLACEHOLDER: Configure Discord webhook
        # webhook_configs:
        #   - url: 'https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN'
        #     send_resolved: true

      # Info alerts (optional - low priority)
      - name: 'info-alerts'
        # PLACEHOLDER: Configure Discord webhook
        # Note: You may want to skip info alerts or use a separate low-priority channel
        # webhook_configs:
        #   - url: 'https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN'
        #     send_resolved: false

    # Templates for notifications (optional - for future customization)
    templates: []
