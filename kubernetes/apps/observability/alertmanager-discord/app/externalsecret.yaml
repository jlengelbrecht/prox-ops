---
# ExternalSecret for alertmanager-discord webhook URLs
# Fetches Discord webhook URLs from 1Password
#
# Setup in 1Password:
# 1. Create a new Login item called "alertmanager_discord"
# 2. Add custom fields for each webhook URL:
#    - critical_webhook: https://discord.com/api/webhooks/ID/TOKEN
#    - security_webhook: https://discord.com/api/webhooks/ID/TOKEN
#    - general_webhook: https://discord.com/api/webhooks/ID/TOKEN
#
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: alertmanager-discord-webhooks
  namespace: observability
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: onepassword-connect
    kind: ClusterSecretStore
  target:
    name: alertmanager-discord-webhooks
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Primary webhook (critical alerts)
        critical_webhook: "{{ .critical_webhook }}"
        # Additional webhooks as comma-separated list (security, general)
        additional_webhooks: "{{ .security_webhook }},{{ .general_webhook }}"
  data:
    - secretKey: critical_webhook
      remoteRef:
        key: alertmanager_discord
        property: critical_webhook
    - secretKey: security_webhook
      remoteRef:
        key: alertmanager_discord
        property: security_webhook
    - secretKey: general_webhook
      remoteRef:
        key: alertmanager_discord
        property: general_webhook
