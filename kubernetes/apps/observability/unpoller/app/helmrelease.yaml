---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: unpoller
  namespace: observability
spec:
  interval: 30m
  chart:
    spec:
      chart: unpoller
      # renovate: datasource=helm registryUrl=https://unpoller.github.io/helm-chart
      version: 2.11.2-Chart6
      sourceRef:
        kind: HelmRepository
        name: unpoller
        namespace: observability
      interval: 30m
  values:
    # Pod configuration
    replicaCount: 1

    image:
      repository: ghcr.io/unpoller/unpoller
      pullPolicy: IfNotPresent
      # renovate: datasource=docker depName=ghcr.io/unpoller/unpoller
      tag: v2.14.2

    # Service configuration
    service:
      type: ClusterIP
      port: 9130

    # Resource limits
    resources:
      requests:
        cpu: 10m
        memory: 64Mi
      limits:
        cpu: 100m
        memory: 128Mi

    # UnPoller configuration
    # Credentials come from environment variables via ExternalSecret
    upConfig:
      poller:
        debug: false
        quiet: false
        plugins: []

      prometheus:
        disable: false
        http_listen: "0.0.0.0:9130"
        report_errors: false

      influxdb:
        disable: true

      loki:
        disable: true

      unifi:
        dynamic: false
        defaults:
          # Credentials are loaded from environment variables:
          # UP_UNIFI_DEFAULT_USER, UP_UNIFI_DEFAULT_PASS, UP_UNIFI_DEFAULT_URL
          # These are set via the ExternalSecret
          save_sites: true
          save_ids: false
          save_events: false
          save_alarms: false
          save_anomalies: false
          save_dpi: true
          save_rogue: false
          hash_pii: false
          verify_ssl: false
          sites:
            - all

    # Environment variables from ExternalSecret
    env:
      - name: UP_UNIFI_DEFAULT_USER
        valueFrom:
          secretKeyRef:
            name: unpoller-secret
            key: UP_UNIFI_DEFAULT_USER
      - name: UP_UNIFI_DEFAULT_PASS
        valueFrom:
          secretKeyRef:
            name: unpoller-secret
            key: UP_UNIFI_DEFAULT_PASS
      - name: UP_UNIFI_DEFAULT_URL
        valueFrom:
          secretKeyRef:
            name: unpoller-secret
            key: UP_UNIFI_DEFAULT_URL

    # Prometheus ServiceMonitor configuration
    # The chart includes a PodMonitor by default
    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 10s
      labels:
        release: kube-prometheus-stack

    # Grafana dashboards - we'll handle these separately as ConfigMaps
    # to match the existing dashboard pattern in this cluster
    dashboards:
      enabled: false
