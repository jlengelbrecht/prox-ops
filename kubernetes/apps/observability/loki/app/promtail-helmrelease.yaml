---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: promtail
  namespace: observability
spec:
  chart:
    spec:
      chart: promtail
      version: 6.16.6
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: observability
  interval: 1h
  timeout: 15m
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    # DaemonSet configuration
    daemonset:
      enabled: true

    # Deployment disabled (using DaemonSet)
    deployment:
      enabled: false

    # Resource limits
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # Promtail configuration
    config:
      # Loki endpoint
      clients:
        - url: http://loki:3100/loki/api/v1/push
          tenant_id: 1
          batchwait: 1s
          batchsize: 102400
          backoff_config:
            min_period: 500ms
            max_period: 5m
            max_retries: 10
          timeout: 10s

      # Server configuration
      server:
        log_level: info
        log_format: logfmt
        http_listen_port: 3101

      # Positions (where Promtail tracks which logs it has read)
      positions:
        filename: /run/promtail/positions.yaml

      # Scrape configs
      scrape_configs:
        # Kubernetes pods
        - job_name: kubernetes-pods
          pipeline_stages:
            # Extract metadata from Kubernetes labels
            - docker: {}
            - cri: {}
            # Add common labels
            - labeldrop:
                - filename
            # Drop noisy logs
            - match:
                selector: '{app="promtail"}'
                action: drop
            - match:
                selector: '{container="promtail"}'
                action: drop
          kubernetes_sd_configs:
            - role: pod
          relabel_configs:
            # Only scrape running pods
            - source_labels:
                - __meta_kubernetes_pod_phase
              action: keep
              regex: Running
            # Add namespace label
            - source_labels:
                - __meta_kubernetes_namespace
              action: replace
              target_label: namespace
            # Add pod name label
            - source_labels:
                - __meta_kubernetes_pod_name
              action: replace
              target_label: pod
            # Add container name label
            - source_labels:
                - __meta_kubernetes_pod_container_name
              action: replace
              target_label: container
            # Add node name label
            - source_labels:
                - __meta_kubernetes_pod_node_name
              action: replace
              target_label: node
            # Add pod labels as labels (with prefix)
            - action: labelmap
              regex: __meta_kubernetes_pod_label_(.+)
            # Add pod annotations as labels (with prefix)
            - action: labelmap
              regex: __meta_kubernetes_pod_annotation_(.+)
            # Set path to pod logs
            - source_labels:
                - __meta_kubernetes_pod_uid
                - __meta_kubernetes_pod_container_name
              action: replace
              separator: /
              target_label: __path__
              replacement: /var/log/pods/*$1/*.log

        # Systemd journal logs
        - job_name: journal
          journal:
            path: /var/log/journal
            max_age: 12h
            labels:
              job: systemd-journal
          relabel_configs:
            # Add hostname
            - source_labels:
                - __journal__hostname
              target_label: node
            # Add systemd unit
            - source_labels:
                - __journal__systemd_unit
              target_label: unit
            # Add syslog identifier
            - source_labels:
                - __journal_syslog_identifier
              target_label: syslog_identifier
          pipeline_stages:
            # Drop noisy journal entries
            - match:
                selector: '{unit="systemd-journald.service"}'
                action: drop
            - match:
                selector: '{syslog_identifier="systemd"} |~ "Started|Stopped|Reached target"'
                action: drop

    # Volume mounts
    extraVolumes:
      - name: pods
        hostPath:
          path: /var/log/pods
      - name: journal
        hostPath:
          path: /var/log/journal

    extraVolumeMounts:
      - name: pods
        mountPath: /var/log/pods
        readOnly: true
      - name: journal
        mountPath: /var/log/journal
        readOnly: true

    # Service configuration
    service:
      enabled: true
      type: ClusterIP
      port: 3101
      targetPort: 3101
      labels:
        app: promtail

    # ServiceMonitor for Prometheus
    serviceMonitor:
      enabled: true
      labels:
        prometheus: kube-prometheus-stack
      interval: 30s
      scrapeTimeout: 10s

    # RBAC
    rbac:
      create: true
      pspEnabled: false

    # Service account
    serviceAccount:
      create: true
      name: promtail

    # Pod security context
    podSecurityContext:
      runAsUser: 0
      runAsGroup: 0
      fsGroup: 0

    # Container security context
    containerSecurityContext:
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL
      allowPrivilegeEscalation: false
      privileged: false

    # Node selector and tolerations
    nodeSelector: {}

    tolerations:
      - effect: NoSchedule
        operator: Exists

    # Update strategy
    updateStrategy:
      type: RollingUpdate
      rollingUpdate:
        maxUnavailable: 1

    # Priority class
    priorityClassName: ""

    # Init container to set up directories
    initContainer:
      enabled: false
