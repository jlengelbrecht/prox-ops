---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: n8n
  namespace: tools
spec:
  chart:
    spec:
      chart: n8n
      # renovate: datasource=helm registryUrl=oci://8gears.container-registry.com/library
      version: 2.0.1
      sourceRef:
        kind: HelmRepository
        name: n8n
        namespace: tools
  interval: 1h
  values:
    # Main n8n configuration
    main:
      # Container image - explicit for Renovate tracking
      image:
        repository: n8nio/n8n
        # renovate: datasource=docker depName=n8nio/n8n
        tag: 2.1.0

      # Environment config (becomes ENV vars)
      config:
        n8n:
          host: n8n.homelab0.org
          port: 5678
          protocol: https
          # Webhook URL for external triggers
          webhook_url: https://n8n.homelab0.org/
          # Disable built-in auth - using Authentik forward auth (SSO)
          basic_auth_active: false
        executions:
          # Prune old executions to save space
          pruneData: "true"
          pruneDataMaxAge: "168"  # 7 days in hours

      # Environment variables from secrets (8gears chart uses dict format)
      extraEnv:
        N8N_ENCRYPTION_KEY:
          valueFrom:
            secretKeyRef:
              name: n8n-secrets
              key: N8N_ENCRYPTION_KEY

      # Persistence configuration - cattle-proof
      persistence:
        enabled: true
        type: existing
        existingClaim: n8n-data

      # Resource limits
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 1
          memory: 1Gi

      # Pod security context (PSA restricted compliant)
      podSecurityContext:
        runAsUser: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile:
          type: RuntimeDefault

      # Container security context
      securityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: false
        capabilities:
          drop:
            - ALL

      # Pod annotations
      podAnnotations:
        # Stakater Reloader: restart pod when 1Password secret changes
        secret.reloader.stakater.com/reload: "n8n-secrets"
        security.homelab/network: "Internal only - workflow automation"
        security.homelab/storage: "Ceph RBD for workflow persistence"

    # Service configuration - using chart defaults (port 80 -> targetPort 5678)
    service:
      enabled: true
      type: ClusterIP
