---
# MCPServer for CodeRabbit AI Reviews
# Using stdio transport - proxyrunner handles protocol translation
# Source: https://github.com/bradthebeeble/coderabbitai-mcp
apiVersion: toolhive.stacklok.dev/v1alpha1
kind: MCPServer
metadata:
  name: coderabbit
  namespace: mcp
  annotations:
    # Registry discovery annotations
    toolhive.stacklok.dev/registry-export: "true"
    # Route through proxyrunner for auth, audit, and security features
    toolhive.stacklok.dev/registry-url: "http://mcp-coderabbit-proxy.mcp.svc.cluster.local:8080/mcp"
    toolhive.stacklok.dev/registry-description: "CodeRabbit AI - Retrieve and manage CodeRabbit code review suggestions on GitHub pull requests."
    # Catalog metadata for registry.json generation (used by CI/CD)
    toolhive.stacklok.dev/catalog-title: "CodeRabbit MCP"
    toolhive.stacklok.dev/catalog-tags: "coderabbit,code-review,github,pull-requests,ai-review,homelab,automation"
    toolhive.stacklok.dev/catalog-tools: "get_coderabbit_reviews,get_review_details,get_review_comments,get_comment_details,resolve_comment"
    toolhive.stacklok.dev/repository-url: "https://github.com/bradthebeeble/coderabbitai-mcp"
  labels:
    app.kubernetes.io/name: coderabbit
    app.kubernetes.io/component: mcp-server
    app.kubernetes.io/part-of: toolhive-gateway
spec:
  # Built from source via GitHub Actions workflow
  # Image tags use YYYYMMDD-sha format from upstream commits
  # renovate: datasource=docker depName=ghcr.io/jlengelbrecht/coderabbitai-mcp versioning=loose
  image: ghcr.io/jlengelbrecht/coderabbitai-mcp:20260120-c6b2fad
  # stdio transport - proxyrunner attaches to container stdin/stdout
  transport: stdio
  # Proxy exposes stdio as streamable-http for HTTP clients
  proxyMode: streamable-http
  proxyPort: 8080
  # Link to MCPGroup for VirtualMCPServer aggregation
  groupRef: homelab-mcp
  # Network permission profile (needs to reach GitHub API)
  permissionProfile:
    type: builtin
    name: network
  # Environment variables (non-secret)
  env:
    - name: CODERABBIT_LOG_LEVEL
      value: "info"
  # Secrets from ExternalSecret
  secrets:
    - name: coderabbit-mcp-secrets
      key: github-pat
      targetEnvName: GITHUB_PAT
  # Resource limits
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  # Pod customization for security context
  podTemplateSpec:
    metadata:
      annotations:
        secret.reloader.stakater.com/reload: "coderabbit-mcp-secrets"
    spec:
      automountServiceAccountToken: false
      securityContext:
        runAsUser: 1001
        runAsGroup: 1001
        runAsNonRoot: true
        fsGroup: 1001
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: mcp
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
