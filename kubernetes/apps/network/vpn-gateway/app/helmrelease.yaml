---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: vpn-gateway
  namespace: network
spec:
  chart:
    spec:
      chart: app-template
      version: 4.4.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: network
  interval: 1h
  values:
    controllers:
      vpn-gateway:
        strategy: Recreate  # Only one instance at a time
        containers:
          app:
            image:
              repository: ghcr.io/qdm12/gluetun
              tag: v3.39.1
            env:
              # VPN Configuration
              - name: VPN_SERVICE_PROVIDER
                value: "custom"
              - name: VPN_TYPE
                value: "wireguard"
              # Timezone
              - name: TZ
                value: "America/New_York"
              # Logging
              - name: LOG_LEVEL
                value: "info"
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - /gluetun-entrypoint
                      - healthcheck
                  initialDelaySeconds: 30
                  periodSeconds: 30
                  timeoutSeconds: 10
                  failureThreshold: 3
              readiness:
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - /gluetun-entrypoint
                      - healthcheck
                  initialDelaySeconds: 30
                  periodSeconds: 30
                  timeoutSeconds: 10
                  failureThreshold: 3
            resources:
              requests:
                cpu: 10m
                memory: 64Mi
              limits:
                cpu: 1000m
                memory: 256Mi
            # CRITICAL: Gluetun needs NET_ADMIN to create WireGuard interface
            securityContext:
              capabilities:
                add:
                  - NET_ADMIN
              readOnlyRootFilesystem: false  # Gluetun needs to write to /tmp and /gluetun
    defaultPodOptions:
      # Pod-level security
      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile:
          type: RuntimeDefault
      # Annotations
      annotations:
        reloader.stakater.com/auto: "true"
    persistence:
      # Mount WireGuard config from secret
      wireguard-config:
        enabled: true
        type: secret
        name: surfshark-wireguard
        globalMounts:
          - path: /gluetun/wireguard/wg0.conf
            subPath: wg0.conf
            readOnly: true
    service:
      app:
        controller: vpn-gateway
        # Note: This service is for monitoring/health checks
        # Pods will use Gluetun by sharing network namespace
        ports:
          http:
            port: 8000  # Gluetun control server
            protocol: TCP
