---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gluetun
spec:
  chartRef:
    kind: OCIRepository
    name: gluetun
  interval: 1h
  values:
    controllers:
      gluetun:
        containers:
          app:
            image:
              repository: ghcr.io/qdm12/gluetun
              tag: v3.40.0
            env:
              # VPN Provider Configuration
              - name: VPN_SERVICE_PROVIDER
                value: "surfshark"
              - name: VPN_TYPE
                value: "wireguard"
              - name: SERVER_COUNTRIES
                value: "United States"

              # HTTP Proxy Configuration (CRITICAL)
              - name: HTTPPROXY
                value: "on"
              - name: HTTPPROXY_LOG
                value: "on"

              # Firewall Kill Switch (CRITICAL)
              - name: FIREWALL
                value: "on"
              - name: FIREWALL_VPN_INPUT_PORTS
                value: "8888,8388,8000"
              - name: FIREWALL_OUTBOUND_SUBNETS
                value: "10.43.0.0/16"
              - name: FIREWALL_INPUT_PORTS
                value: "8000,8888,8388"  # Allow probes and proxy access from pod network
              - name: DISABLE_IPV6
                value: "yes"

              # DNS Configuration
              - name: DOT
                value: "off"
              - name: DNS_KEEP_NAMESERVER
                value: "on"

              # Logging
              - name: LOG_LEVEL
                value: "info"
              - name: TZ
                value: "America/New_York"

              # Process UID/GID (must be root for VPN operations)
              - name: PUID
                value: "0"
              - name: PGID
                value: "0"

            # Credentials from 1Password via ExternalSecret
            envFrom:
              - secretRef:
                  name: gluetun-surfshark-credentials

            # Security Context (from security-guardian review)
            securityContext:
              capabilities:
                drop: [ALL]
                add: [NET_ADMIN]  # Required for WireGuard
              seccompProfile:
                type: RuntimeDefault
              readOnlyRootFilesystem: false  # Gluetun needs /tmp
              runAsNonRoot: false  # Gluetun requires root
              runAsUser: 0  # Explicitly run as root UID
              allowPrivilegeEscalation: false  # Prevent setuid/setgid escalation

            # Resource Limits
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 500m
                memory: 512Mi

            # Probes
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /v1/publicip/ip
                    port: &controlPort 8000
                  initialDelaySeconds: 30
                  periodSeconds: 30
                  timeoutSeconds: 5
                  failureThreshold: 3
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /v1/publicip/ip
                    port: *controlPort
                  initialDelaySeconds: 15
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3

    # Service Configuration
    service:
      app:
        controller: gluetun
        ports:
          http-proxy:
            port: 8888  # HTTP proxy (primary)
            protocol: TCP
          socks-proxy:
            port: 8388  # SOCKS5 proxy (future)
            protocol: TCP
          control:
            port: *controlPort  # Gluetun control server
            protocol: TCP

    # Persistence - TUN device for WireGuard
    persistence:
      dev-tun:
        enabled: true
        type: hostPath
        hostPath: /dev/net/tun
        hostPathType: CharDevice
        globalMounts:
          - path: /dev/net/tun
