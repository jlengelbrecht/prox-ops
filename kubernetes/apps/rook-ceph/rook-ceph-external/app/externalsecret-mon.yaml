---
# ExternalSecret for rook-ceph-mon
# This is the PRIMARY secret that Rook operator looks for when connecting to external Ceph cluster
# 1Password Item: rook_ceph_external_cluster (Automation vault)
#
# The rook-ceph-mon secret is required for Rook to connect to an external Ceph cluster
# It provides the cluster FSID, admin credentials, and cluster name
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: rook-ceph-mon
  namespace: rook-ceph
spec:
  refreshInterval: 5m
  secretStoreRef:
    name: onepassword-connect
    kind: ClusterSecretStore
  target:
    name: rook-ceph-mon
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Static cluster name for external cluster
        cluster-name: "rook-ceph-external"
        # FSID from 1Password
        fsid: "{{ .fsid }}"
        # Admin secret (same as ceph-secret for client.k8s user)
        admin-secret: "{{ .cephsecret }}"
        # Monitor secret (required by Rook operator for cluster identity validation)
        # For external clusters using client.k8s user, set to same value as ceph-secret
        mon-secret: "{{ .cephsecret }}"
        # Ceph username
        ceph-username: "{{ .cephusername }}"
        # Ceph secret (keyring)
        ceph-secret: "{{ .cephsecret }}"
  data:
    - secretKey: fsid
      remoteRef:
        key: rook_ceph_external_cluster
        property: fsid
    - secretKey: cephsecret
      remoteRef:
        key: rook_ceph_external_cluster
        property: ceph-secret
    - secretKey: cephusername
      remoteRef:
        key: rook_ceph_external_cluster
        property: ceph-username
