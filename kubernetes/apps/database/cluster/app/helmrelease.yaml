---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: postgres-cluster
  namespace: database
spec:
  chart:
    spec:
      chart: cluster
      # renovate: datasource=helm registryUrl=https://cloudnative-pg.github.io/charts
      version: 0.5.0
      sourceRef:
        kind: HelmRepository
        name: cloudnative-pg
        namespace: database
  interval: 1h
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    # Cluster name
    fullnameOverride: postgres

    # PostgreSQL version - pin major version for stability
    # Renovate will propose minor/patch updates within 16.x
    version:
      postgresql: "16"

    # Single instance for homelab (can scale to 3 for HA later)
    cluster:
      instances: 1

      # Storage configuration
      storage:
        size: 20Gi
        storageClass: ceph-block

      # Resource limits
      resources:
        requests:
          cpu: 250m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 2Gi

      # Enable monitoring if Prometheus is available
      monitoring:
        enabled: false
        podMonitor:
          enabled: false

      # Superuser credentials from ExternalSecret
      superuserSecret: postgres-superuser

    # Disable backups for now (no S3 configured)
    backups:
      enabled: false

    # Database provisioning - apps request databases here
    # Each app gets its own database and user
    databases:
      # Firecrawl database
      - name: firecrawl
        owner: firecrawl
        ensure: present

    # Connection pooling with PgBouncer (optional, enable if needed)
    poolers: []
