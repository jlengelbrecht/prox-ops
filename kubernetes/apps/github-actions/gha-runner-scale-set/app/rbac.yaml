---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: github-actions-runner
  namespace: github-actions
---
# Namespace-scoped operations (most permissions)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: github-actions-runner
  namespace: github-actions
rules:
  # Pods and Jobs (namespace-scoped)
  - apiGroups: [""]
    resources: ["pods", "pods/log", "pods/status"]
    verbs: ["get", "list", "create", "delete", "watch"]
  - apiGroups: ["batch"]
    resources: ["jobs", "cronjobs"]
    verbs: ["get", "list", "create", "delete", "patch"]
  # Secrets (only in github-actions namespace)
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list"]
  # ConfigMaps
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "create", "patch"]
  # Services
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["get", "list"]
---
# Cluster-scoped operations (only what's absolutely needed)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: github-actions-runner-cluster
rules:
  # Node operations (required for cattle upgrade workflow)
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch", "patch"]  # patch required for cordon/uncordon
  # IMPORTANT: We CANNOT restrict to nodes/status because kubectl cordon/uncordon
  # modifies .spec.unschedulable which is part of the nodes resource.
  # This is a Kubernetes API limitation - there is no way to grant ONLY cordon
  # permission without granting general node patch.
  # Pod eviction (required for kubectl drain during cattle upgrades)
  - apiGroups: [""]
    resources: ["pods/eviction"]
    verbs: ["create"]
  # Pod read access (required for drain to list pods on node)
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]
  # HelmReleases and Kustomizations (read-only cluster-wide)
  - apiGroups: ["helm.toolkit.fluxcd.io"]
    resources: ["helmreleases"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["kustomize.toolkit.fluxcd.io"]
    resources: ["kustomizations"]
    verbs: ["get", "list", "watch"]
  # Namespace read access
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list"]
---
# Bind namespace-scoped Role
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: github-actions-runner
  namespace: github-actions
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: github-actions-runner
subjects:
  - kind: ServiceAccount
    name: github-actions-runner
    namespace: github-actions
---
# Bind cluster-scoped ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: github-actions-runner-cluster
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: github-actions-runner-cluster
subjects:
  - kind: ServiceAccount
    name: github-actions-runner
    namespace: github-actions
