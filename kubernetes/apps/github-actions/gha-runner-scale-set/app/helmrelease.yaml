---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gha-runner-scale-set
  namespace: github-actions
spec:
  chartRef:
    kind: OCIRepository
    name: gha-runner-scale-set
  interval: 1h
  dependsOn:
    - name: gha-runner-scale-set-controller
      namespace: github-actions
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    # Runner scale set name (used in runs-on: [self-hosted, cattle-upgrade])
    runnerScaleSetName: "cattle-upgrade"

    # GitHub configuration
    githubConfigUrl: "https://github.com/jlengelbrecht/prox-ops"

    # GitHub App authentication (secret created by ExternalSecret)
    githubConfigSecret: github-runner-registration

    # Scaling configuration
    # minRunners: 1 maintains one "warm" runner to avoid race conditions
    # where jobs are canceled before on-demand runners can start (ARC issue #4000)
    # The JIT token bug with minRunners > 0 was fixed in ARC 0.13.0
    minRunners: 1   # One warm runner for immediate job pickup
    maxRunners: 10  # Allow scaling for parallel jobs

    # Runner template
    template:
      spec:
        # Service account with kubectl/cluster access
        serviceAccountName: github-actions-runner

        # Pod-level security context
        securityContext:
          runAsNonRoot: true
          runAsUser: 1001
          fsGroup: 1001
          seccompProfile:
            type: RuntimeDefault

        # Container spec
        containers:
          - name: runner
            image: ghcr.io/actions/actions-runner:2.329.0
            imagePullPolicy: IfNotPresent

            # Resource allocation
            resources:
              requests:
                cpu: 500m
                memory: 1Gi
              limits:
                cpu: 2000m
                memory: 4Gi

            # CRITICAL FIX: ARC 0.13.0 doesn't propagate runnerScaleSetName to GitHub as a label
            # We must explicitly set runner label env vars to force runner registration with label
            # Without this, runners register with labels:[] and workflows stay queued forever
            # Reference: ChatGPT Deep Research (arc-empty-labels-issue.md)
            # Trying both env var names since different runner versions may use different names
            env:
              - name: RUNNER_LABELS
                value: "cattle-upgrade"
              - name: ACTIONS_RUNNER_INPUT_LABELS
                value: "cattle-upgrade"

            # Security context (container-level)
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                  - ALL

            # Add pre-stop hook for graceful shutdown during node drain
            lifecycle:
              preStop:
                exec:
                  command:
                    - /bin/sh
                    - -c
                    - |
                      # Give running job time to checkpoint/save state
                      echo "PreStop hook: Graceful shutdown initiated"
                      sleep 25

            # Volume mounts for tools
            volumeMounts:
              - name: work
                mountPath: /home/runner/_work

        # Volumes
        volumes:
          - name: work
            emptyDir: {}

        # Graceful termination (60s: 25s preStop + 35s for runner cleanup)
        terminationGracePeriodSeconds: 60

        # Affinity rules for spreading runners across nodes
        affinity:
          # Node affinity: prefer worker nodes, avoid control plane
          nodeAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                preference:
                  matchExpressions:
                    - key: node-role.kubernetes.io/control-plane
                      operator: DoesNotExist

          # Pod anti-affinity: PREFERRED (not required) to spread runners
          # Changed from required to preferred for better scheduling flexibility
          podAntiAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                podAffinityTerm:
                  labelSelector:
                    matchExpressions:
                      - key: actions.github.com/scale-set-name
                        operator: In
                        values:
                          - cattle-upgrade
                  topologyKey: kubernetes.io/hostname

        # Tolerations (avoid GPU nodes unless necessary)
        tolerations: []

    # Controller service account
    controllerServiceAccount:
      name: gha-runner-scale-set-controller
      namespace: github-actions
