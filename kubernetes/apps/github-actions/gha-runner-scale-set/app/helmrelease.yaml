---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gha-runner-scale-set
  namespace: github-actions
spec:
  chartRef:
    kind: OCIRepository
    name: gha-runner-scale-set
  interval: 1h
  dependsOn:
    - name: gha-runner-scale-set-controller
      namespace: github-actions
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    # Runner scale set name (used in runs-on: [self-hosted, cattle-upgrade])
    runnerScaleSetName: "cattle-upgrade"

    # GitHub configuration
    githubConfigUrl: "https://github.com/jlengelbrecht/prox-ops"

    # GitHub App authentication (secret created by ExternalSecret)
    githubConfigSecret: github-runner-registration

    # Scaling configuration (fixed 3 runners for cattle upgrade resilience)
    # Per Opus's design: 3 runners with anti-affinity ensures 2 survive any single node drain
    minRunners: 3
    maxRunners: 3

    # Runner template
    template:
      spec:
        # Service account with kubectl/cluster access
        serviceAccountName: github-actions-runner

        # Pod-level security context
        securityContext:
          runAsNonRoot: true
          runAsUser: 1001
          fsGroup: 1001
          seccompProfile:
            type: RuntimeDefault

        # Container spec
        containers:
          - name: runner
            image: ghcr.io/actions/actions-runner:2.329.0
            imagePullPolicy: IfNotPresent

            # Resource allocation
            resources:
              requests:
                cpu: 500m
                memory: 1Gi
              limits:
                cpu: 2000m
                memory: 4Gi

            # Security context (container-level)
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                  - ALL

            # Volume mounts for tools
            volumeMounts:
              - name: work
                mountPath: /home/runner/_work

        # Volumes
        volumes:
          - name: work
            emptyDir: {}

        # Affinity rules (CRITICAL for cattle upgrade resilience)
        affinity:
          # Node affinity: prefer worker nodes, avoid control plane
          nodeAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                preference:
                  matchExpressions:
                    - key: node-role.kubernetes.io/control-plane
                      operator: DoesNotExist

          # Pod anti-affinity: REQUIRED - force runners on different nodes
          # This ensures that when any single node is drained during cattle upgrade,
          # at least 2 runners survive to continue the workflow
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: actions.github.com/scale-set-name
                      operator: In
                      values:
                        - cattle-upgrade
                topologyKey: kubernetes.io/hostname

        # Tolerations (avoid GPU nodes unless necessary)
        tolerations: []

    # Controller service account
    controllerServiceAccount:
      name: gha-runner-scale-set-controller
      namespace: github-actions
