---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nvidia-device-plugin
spec:
  chart:
    spec:
      chart: nvidia-device-plugin
      version: 0.18.0  # Testing upgrade - eBPF issue was in nvidia-container-toolkit, not device plugin
      sourceRef:
        kind: HelmRepository
        name: nvidia-device-plugin
        namespace: kube-system
  interval: 1h
  timeout: 10m
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    # CRITICAL: Use nvidia runtime to inject NVIDIA libraries
    runtimeClassName: nvidia

    # CRITICAL: Add SYS_ADMIN capability for library access with volume-mounts
    # This is required for v0.16+ but won't hurt in v0.13.0
    securityContext:
      capabilities:
        add:
          - SYS_ADMIN

    # Only run on nodes with NVIDIA GPUs
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                # Match nodes with the nvidia.com/gpu.present label
                - key: nvidia.com/gpu.present
                  operator: In
                  values:
                    - "true"

    # Tolerations for GPU nodes (if you add taints later)
    tolerations:
      - key: nvidia.com/gpu
        operator: Exists
        effect: NoSchedule
      - key: CriticalAddonsOnly
        operator: Exists

    # Resources for the device plugin pods
    resources:
      requests:
        cpu: 50m
        memory: 100Mi
      limits:
        memory: 200Mi

    # Priority class for critical system pods
    priorityClassName: system-node-critical

    # Update strategy
    updateStrategy:
      type: RollingUpdate
      rollingUpdate:
        maxUnavailable: 1
