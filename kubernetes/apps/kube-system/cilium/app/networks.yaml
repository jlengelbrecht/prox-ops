# Cilium Multi-VLAN LoadBalancer Configuration
# Implements network segmentation for LoadBalancer services
# STORY-020: Cilium Multi-VLAN LoadBalancer Segmentation

# ====================================
# CLUSTER VLAN 66 (eth0) - 10.20.66.0/23
# ====================================
# Primary cluster network for internal services
# Services: k8s-gateway, envoy-internal, envoy-external, grafana
---
apiVersion: cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: pool
spec:
  allowFirstLastIPs: "No"
  blocks:
    - cidr: "10.20.66.0/23"
---
apiVersion: cilium.io/v2alpha1
kind: CiliumL2AnnouncementPolicy
metadata:
  name: l2-policy
spec:
  loadBalancerIPs: true
  # Restrict to eth0 interface only (cluster network)
  interfaces:
    - ^eth0$
  nodeSelector:
    matchLabels:
      kubernetes.io/os: linux
  # Only announce services without network label (default pool)
  serviceSelector:
    matchExpressions:
      - key: network
        operator: DoesNotExist

# ====================================
# DMZ VLAN 81 (eth2) - 10.20.81.0/24
# ====================================
# DMZ network for externally-facing services
# Future services: Plex, game servers, public-facing apps
---
apiVersion: cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: dmz-pool
spec:
  allowFirstLastIPs: "No"
  blocks:
    - start: "10.20.81.100"
      stop: "10.20.81.150"
  serviceSelector:
    matchLabels:
      network: dmz
---
apiVersion: cilium.io/v2alpha1
kind: CiliumL2AnnouncementPolicy
metadata:
  name: dmz-l2-policy
spec:
  loadBalancerIPs: true
  # Restrict to eth2 interface only (DMZ network)
  interfaces:
    - ^eth2$
  # Only select worker nodes (exclude control plane nodes without eth1/eth2)
  nodeSelector:
    matchExpressions:
      - key: node-role.kubernetes.io/control-plane
        operator: DoesNotExist
  # Only announce DMZ services
  serviceSelector:
    matchLabels:
      network: dmz

# ====================================
# IoT VLAN 62 (eth1) - 10.20.62.0/24
# ====================================
# IoT network for home automation services
# Future services: Home Assistant, MQTT, Zigbee2MQTT
---
apiVersion: cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: iot-pool
spec:
  allowFirstLastIPs: "No"
  blocks:
    - start: "10.20.62.100"
      stop: "10.20.62.150"
  serviceSelector:
    matchLabels:
      network: iot
---
apiVersion: cilium.io/v2alpha1
kind: CiliumL2AnnouncementPolicy
metadata:
  name: iot-l2-policy
spec:
  loadBalancerIPs: true
  # Restrict to eth1 interface only (IoT network)
  interfaces:
    - ^eth1$
  # Only select worker nodes (exclude control plane nodes without eth1/eth2)
  nodeSelector:
    matchExpressions:
      - key: node-role.kubernetes.io/control-plane
        operator: DoesNotExist
  # Only announce IoT services
  serviceSelector:
    matchLabels:
      network: iot

# ====================================
# SERVICE LABELING GUIDE
# ====================================
# To deploy a service on a specific VLAN, add a network label:
#
# IoT VLAN 62 (10.20.62.100-150):
# metadata:
#   labels:
#     network: iot
#
# DMZ VLAN 81 (10.20.81.100-150):
# metadata:
#   labels:
#     network: dmz
#
# Cluster VLAN 66 (10.20.66.0/23):
# metadata:
#   labels:
#     network: cluster  # or no label (default)
#
# Default behavior: Services without a network label will
# use the default "pool" (cluster VLAN 66)