---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: tetragon
  namespace: kube-system
spec:
  interval: 30m
  chart:
    spec:
      chart: tetragon
      version: 1.2.0
      sourceRef:
        kind: HelmRepository
        name: cilium-charts
        namespace: kube-system
  install:
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    crds: CreateReplace
    remediation:
      retries: 3
  values:
    # Tetragon configuration optimized for Talos Linux
    tetragon:
      enabled: true
      image:
        repository: quay.io/cilium/tetragon
        tag: v1.2.0

      # Prometheus metrics export
      prometheus:
        enabled: true
        port: 2112
        serviceMonitor:
          enabled: true

      # Resource limits to prevent DoS
      resources:
        limits:
          cpu: 500m
          memory: 500Mi
        requests:
          cpu: 250m
          memory: 400Mi

      # Export settings - JSON logs to stdout for Promtail/Loki
      exportFilename: /dev/stdout
      exportRateLimit: 1000  # events/second

      # Enable JSON export for structured logging
      exportAllowList: "{}"
      exportDenyList: "{}"

      # gRPC server for tetra CLI
      grpc:
        enabled: true
        address: "localhost:54321"

      # Enable field filters for better log structure
      enableK8sAPI: true

    # Tetragon Operator configuration
    tetragonOperator:
      enabled: true
      image:
        repository: quay.io/cilium/tetragon-operator
        tag: v1.2.0
      resources:
        limits:
          cpu: 100m
          memory: 128Mi
        requests:
          cpu: 50m
          memory: 64Mi

      # Prometheus metrics for operator
      prometheus:
        enabled: true
        port: 2113
        serviceMonitor:
          enabled: true
