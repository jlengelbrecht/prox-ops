---
apiVersion: cilium.io/v1alpha1
kind: TracingPolicyNamespaced
metadata:
  name: sensitive-file-access-iot
  namespace: iot
spec:
  # HIGH: Monitor access to sensitive files in IoT containers
  # Detects attempts to read credentials, SSH keys, etc.
  kprobes:
  - call: "sys_openat"
    syscall: true
    args:
    - index: 0
      type: "int"
    - index: 1
      type: "string"
    - index: 2
      type: "int"
    selectors:
    - matchArgs:
      - index: 1
        operator: "Prefix"
        values:
        - "/etc/shadow"        # Password hashes
        - "/etc/passwd"        # User accounts
        - "/root/.ssh/"        # SSH keys
        - "/home/*/.ssh/"      # User SSH keys
        - "/etc/kubernetes/"   # K8s configs
        - "/var/run/secrets/"  # K8s service account tokens
      matchActions:
      - action: Post  # LOG: Record sensitive file access
---
apiVersion: cilium.io/v1alpha1
kind: TracingPolicyNamespaced
metadata:
  name: config-modification-iot
  namespace: iot
spec:
  # HIGH: Detect configuration file modifications in IoT
  # Home Assistant config should only be modified by HA itself
  kprobes:
  - call: "sys_openat"
    syscall: true
    args:
    - index: 0
      type: "int"
    - index: 1
      type: "string"
    - index: 2
      type: "int"
    selectors:
    - matchArgs:
      - index: 1
        operator: "Prefix"
        values:
        - "/config/"  # Home Assistant configuration directory
      - index: 2
        operator: "Mask"
        values:
        - "1"  # O_WRONLY
        - "2"  # O_RDWR
      matchActions:
      - action: Post  # LOG: Record config modifications
