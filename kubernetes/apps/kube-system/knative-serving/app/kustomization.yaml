---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: knative-serving

resources:
  # Knative Serving CRDs
  - https://github.com/knative/serving/releases/download/knative-v1.15.2/serving-crds.yaml
  # Knative Serving Core (includes namespace)
  - https://github.com/knative/serving/releases/download/knative-v1.15.2/serving-core.yaml
  # Kourier networking layer (lightweight alternative to Istio)
  - https://github.com/knative/net-kourier/releases/download/knative-v1.15.1/kourier.yaml

configMapGenerator:
  - name: config-autoscaler
    namespace: knative-serving
    behavior: merge
    literals:
      - enable-scale-to-zero=true
      - scale-to-zero-grace-period=5m
      - stable-window=60s
      - target-burst-capacity=200
      - max-scale-up-rate=1000.0
      - max-scale-down-rate=2.0
      - activator-capacity=100.0
      - allow-zero-initial-scale=true
      - initial-scale=0
      - min-scale=0
      - max-scale=10
  - name: config-network
    namespace: knative-serving
    behavior: merge
    literals:
      - ingress-class=kourier.ingress.networking.knative.dev
      - domain-template={{.Name}}.{{.Namespace}}.svc.cluster.local
      - enable-tag-header-based-routing=true
      - http-protocol=HTTP1

patches:
  # Patch Kourier service to use Cilium LoadBalancer with specific IP
  - target:
      kind: Service
      name: kourier
      namespace: knative-serving
    patch: |-
      - op: add
        path: /metadata/annotations/io.cilium~1lb-ipam-ips
        value: 10.20.0.150
