---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  # renovate: datasource=github-releases depName=knative/serving
  # Knative Serving Core (includes CRDs, namespace, and deployments)
  - https://github.com/knative/serving/releases/download/knative-v1.15.2/serving-core.yaml
  # renovate: datasource=github-releases depName=knative/net-kourier
  # Kourier networking layer (lightweight alternative to Istio)
  - https://github.com/knative/net-kourier/releases/download/knative-v1.15.1/kourier.yaml

# Disable hash suffix for ConfigMaps so Knative can find them
generatorOptions:
  disableNameSuffixHash: true

configMapGenerator:
  - name: config-autoscaler
    namespace: knative-serving
    behavior: merge
    literals:
      - enable-scale-to-zero=true
      - scale-to-zero-grace-period=5m
      - stable-window=60s
      - target-burst-capacity=200
      - max-scale-up-rate=1000.0
      - max-scale-down-rate=2.0
      - activator-capacity=100.0
      - allow-zero-initial-scale=true
      - initial-scale=0
      - min-scale=0
      - max-scale=10
  - name: config-network
    namespace: knative-serving
    behavior: merge
    literals:
      - ingress-class=kourier.ingress.networking.knative.dev
      - domain-template={{.Name}}.{{.Namespace}}.svc.cluster.local
      - enable-tag-header-based-routing=true
      - http-protocol=HTTP1

patches:
  # Patch Kourier service to use Cilium LoadBalancer with specific IP
  # IP must be within default pool range: 10.20.66.0/23
  - target:
      kind: Service
      name: kourier
      namespace: knative-serving
    patch: |-
      - op: add
        path: /metadata/annotations/lbipam.cilium.io~1ips
        value: "10.20.67.150"
