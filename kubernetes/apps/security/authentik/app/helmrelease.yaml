---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authentik
  namespace: security
spec:
  chart:
    spec:
      chart: authentik
      # renovate: datasource=helm registryUrl=https://charts.goauthentik.io
      version: 2025.10.3
      sourceRef:
        kind: HelmRepository
        name: authentik
        namespace: security
  interval: 1h
  values:
    global:
      env:
        # =============================================================
        # CORE AUTHENTIK SECRETS
        # =============================================================
        - name: AUTHENTIK_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_SECRET_KEY
        - name: AUTHENTIK_BOOTSTRAP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_BOOTSTRAP_PASSWORD
        - name: AUTHENTIK_BOOTSTRAP_EMAIL
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_BOOTSTRAP_EMAIL
        - name: AUTHENTIK_POSTGRESQL__PASSWORD
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: POSTGRES_PASSWORD

        # =============================================================
        # OAUTH2 PROVIDER CREDENTIALS (Direct OIDC)
        # =============================================================
        # Open WebUI
        - name: AUTHENTIK_OPENWEBUI_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_OPENWEBUI_CLIENT_ID
        - name: AUTHENTIK_OPENWEBUI_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_OPENWEBUI_CLIENT_SECRET
        # BookStack
        - name: AUTHENTIK_BOOKSTACK_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_BOOKSTACK_CLIENT_ID
        - name: AUTHENTIK_BOOKSTACK_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_BOOKSTACK_CLIENT_SECRET
        # LiteLLM
        - name: AUTHENTIK_LITELLM_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_LITELLM_CLIENT_ID
        - name: AUTHENTIK_LITELLM_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_LITELLM_CLIENT_SECRET
        # ToolHive
        - name: AUTHENTIK_TOOLHIVE_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_TOOLHIVE_CLIENT_ID
        - name: AUTHENTIK_TOOLHIVE_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_TOOLHIVE_CLIENT_SECRET
        # ToolHive MCP Gateway (public client for CLI/Desktop apps)
        - name: AUTHENTIK_TOOLHIVE_MCP_GATEWAY_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_TOOLHIVE_MCP_GATEWAY_CLIENT_ID

        # =============================================================
        # SOURCE CREDENTIALS
        # =============================================================
        # Plex Source
        - name: AUTHENTIK_PLEX_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_PLEX_CLIENT_ID
        - name: AUTHENTIK_PLEX_TOKEN
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_PLEX_TOKEN
        - name: AUTHENTIK_PLEX_SERVER_ID
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_PLEX_SERVER_ID
        # UniFi Identity Enterprise Source
        - name: AUTHENTIK_UID_CONSUMER_KEY
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_UID_CONSUMER_KEY
        - name: AUTHENTIK_UID_CONSUMER_SECRET
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_UID_CONSUMER_SECRET

    authentik:
      error_reporting:
        enabled: false
      disable_startup_analytics: true

    # Mount blueprints from ConfigMap for GitOps-managed configuration
    blueprints:
      configMaps:
        - authentik-blueprints

    server:
      replicas: 1
      podAnnotations:
        secret.reloader.stakater.com/reload: "authentik-secret"
      resources:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 1Gi
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
      volumes:
        - name: custom-css
          configMap:
            name: authentik-custom-css
      volumeMounts:
        - name: custom-css
          mountPath: /web/dist/custom.css
          subPath: custom.css
          readOnly: true

    worker:
      replicas: 1
      podAnnotations:
        secret.reloader.stakater.com/reload: "authentik-secret"
        configmap.reloader.stakater.com/reload: "authentik-blueprints"
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi

    postgresql:
      enabled: true
      auth:
        existingSecret: authentik-secret
        secretKeys:
          adminPasswordKey: POSTGRES_PASSWORD
          userPasswordKey: POSTGRES_PASSWORD
      primary:
        persistence:
          enabled: true
          existingClaim: data-authentik-postgresql-0  # Use protected PVC

    redis:
      enabled: true
      architecture: standalone
      auth:
        enabled: false
      master:
        persistence:
          enabled: true
          existingClaim: redis-data-authentik-redis-master-0  # Use protected PVC
