---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authentik
  namespace: security
spec:
  chart:
    spec:
      chart: authentik
      # renovate: datasource=helm registryUrl=https://charts.goauthentik.io
      version: 2025.10.3
      sourceRef:
        kind: HelmRepository
        name: authentik
        namespace: security
  interval: 1h
  values:
    global:
      env:
        - name: AUTHENTIK_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_SECRET_KEY
        - name: AUTHENTIK_BOOTSTRAP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_BOOTSTRAP_PASSWORD
        - name: AUTHENTIK_BOOTSTRAP_EMAIL
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: AUTHENTIK_BOOTSTRAP_EMAIL
        - name: AUTHENTIK_POSTGRESQL__PASSWORD
          valueFrom:
            secretKeyRef:
              name: authentik-secret
              key: POSTGRES_PASSWORD

    authentik:
      error_reporting:
        enabled: false
      disable_startup_analytics: true

    server:
      replicas: 1
      resources:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 1Gi
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
      volumes:
        - name: custom-css
          configMap:
            name: authentik-custom-css
      volumeMounts:
        - name: custom-css
          mountPath: /web/dist/custom.css
          subPath: custom.css
          readOnly: true

    worker:
      replicas: 1
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi

    postgresql:
      enabled: true
      auth:
        existingSecret: authentik-secret
        secretKeys:
          adminPasswordKey: POSTGRES_PASSWORD
          userPasswordKey: POSTGRES_PASSWORD
      primary:
        persistence:
          enabled: true
          existingClaim: data-authentik-postgresql-0  # Use protected PVC

    redis:
      enabled: true
      architecture: standalone
      auth:
        enabled: false
      master:
        persistence:
          enabled: true
          existingClaim: redis-data-authentik-redis-master-0  # Use protected PVC
