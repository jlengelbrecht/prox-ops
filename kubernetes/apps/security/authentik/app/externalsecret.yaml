---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: authentik-secret
  namespace: security
spec:
  refreshInterval: 5m
  secretStoreRef:
    name: onepassword-connect
    kind: ClusterSecretStore
  target:
    name: authentik-secret
    creationPolicy: Owner
  data:
    # =============================================================
    # CORE AUTHENTIK SECRETS
    # =============================================================
    - secretKey: AUTHENTIK_SECRET_KEY
      remoteRef:
        key: authentik
        property: secret-key
    - secretKey: AUTHENTIK_BOOTSTRAP_PASSWORD
      remoteRef:
        key: authentik
        property: bootstrap-password
    - secretKey: AUTHENTIK_BOOTSTRAP_EMAIL
      remoteRef:
        key: authentik
        property: bootstrap-email
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: authentik
        property: postgres-password

    # =============================================================
    # OAUTH2 PROVIDER CREDENTIALS (Direct OIDC)
    # =============================================================
    # Open WebUI
    - secretKey: AUTHENTIK_OPENWEBUI_CLIENT_ID
      remoteRef:
        key: authentik
        property: openwebui-client-id
    - secretKey: AUTHENTIK_OPENWEBUI_CLIENT_SECRET
      remoteRef:
        key: authentik
        property: openwebui-client-secret
    # BookStack
    - secretKey: AUTHENTIK_BOOKSTACK_CLIENT_ID
      remoteRef:
        key: authentik
        property: bookstack-client-id
    - secretKey: AUTHENTIK_BOOKSTACK_CLIENT_SECRET
      remoteRef:
        key: authentik
        property: bookstack-client-secret
    # LiteLLM
    - secretKey: AUTHENTIK_LITELLM_CLIENT_ID
      remoteRef:
        key: authentik
        property: litellm-client-id
    - secretKey: AUTHENTIK_LITELLM_CLIENT_SECRET
      remoteRef:
        key: authentik
        property: litellm-client-secret
    # ToolHive UI
    - secretKey: AUTHENTIK_TOOLHIVE_CLIENT_ID
      remoteRef:
        key: authentik
        property: toolhive-client-id
    - secretKey: AUTHENTIK_TOOLHIVE_CLIENT_SECRET
      remoteRef:
        key: authentik
        property: toolhive-client-secret
    - secretKey: AUTHENTIK_TOOLHIVE_AUTH_SECRET
      remoteRef:
        key: authentik
        property: toolhive-auth-secret
    # ToolHive MCP Gateway (public client for CLI/Desktop apps)
    - secretKey: AUTHENTIK_TOOLHIVE_MCP_GATEWAY_CLIENT_ID
      remoteRef:
        key: authentik
        property: toolhive-mcp-gateway-client-id

    # =============================================================
    # SOURCE CREDENTIALS
    # =============================================================
    # Plex Source
    - secretKey: AUTHENTIK_PLEX_CLIENT_ID
      remoteRef:
        key: authentik
        property: plex-client-id
    - secretKey: AUTHENTIK_PLEX_TOKEN
      remoteRef:
        key: authentik
        property: plex-token
    - secretKey: AUTHENTIK_PLEX_SERVER_ID
      remoteRef:
        key: authentik
        property: plex-server-id
    # UniFi Identity Enterprise Source
    - secretKey: AUTHENTIK_UID_CONSUMER_KEY
      remoteRef:
        key: authentik
        property: uid-consumer-key
    - secretKey: AUTHENTIK_UID_CONSUMER_SECRET
      remoteRef:
        key: authentik
        property: uid-consumer-secret

    # =============================================================
    # BLUEPRINT RECONCILIATION API TOKEN
    # =============================================================
    # API token for automated blueprint reconciliation
    # Create in Authentik: Admin > System > Tokens > Create
    # Token should have permissions to manage blueprints
    - secretKey: AUTHENTIK_API_TOKEN
      remoteRef:
        key: authentik
        property: AUTHENTIK_API_TOKEN
