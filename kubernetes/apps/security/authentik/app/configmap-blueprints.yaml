---
# ConfigMap containing Authentik blueprints for GitOps-managed configuration
# These blueprints are auto-discovered and applied by Authentik
apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-blueprints
  namespace: security
data:
  # =============================================================
  # GROUPS BLUEPRINT
  # Defines application-specific user groups
  # =============================================================
  groups.yaml: |
    version: 1
    metadata:
      name: Custom Groups
      labels:
        blueprints.goauthentik.io/description: "Application-specific user groups"
    entries:
      # BookStack Groups
      - model: authentik_core.group
        id: group-bookstack-admins
        identifiers:
          name: bookstack-admins
        attrs:
          name: bookstack-admins
          attributes: {}
      - model: authentik_core.group
        id: group-bookstack-uid-full-access
        identifiers:
          name: bookstack-uid-full-access
        attrs:
          name: bookstack-uid-full-access
          attributes: {}
      - model: authentik_core.group
        id: group-bookstack-extended-users
        identifiers:
          name: bookstack-extended-users
        attrs:
          name: bookstack-extended-users
          attributes: {}
      - model: authentik_core.group
        id: group-bookstack-plex-media-users
        identifiers:
          name: bookstack-plex-media-users
        attrs:
          name: bookstack-plex-media-users
          attributes: {}
      # OpenWebUI Groups
      - model: authentik_core.group
        id: group-openwebui-admins
        identifiers:
          name: openwebui-admins
        attrs:
          name: openwebui-admins
          attributes: {}
      - model: authentik_core.group
        id: group-openwebui-users
        identifiers:
          name: openwebui-users
        attrs:
          name: openwebui-users
          attributes: {}

  # =============================================================
  # CUSTOM SCOPE MAPPINGS BLUEPRINT
  # Custom OAuth2 scope mappings for group claims
  # =============================================================
  scope-mappings.yaml: |
    version: 1
    metadata:
      name: Custom Scope Mappings
      labels:
        blueprints.goauthentik.io/description: "Custom OAuth2 scope mappings for group claims"
    entries:
      - model: authentik_providers_oauth2.scopemapping
        id: scope-bookstack-groups
        identifiers:
          name: BookStack Groups
        attrs:
          name: BookStack Groups
          scope_name: groups
          description: "Returns BookStack access groups based on user authentication source"
          expression: |
            # BookStack Groups - assigns groups based on authentication source
            groups = []

            # Get user's linked source slugs
            source_slugs = []
            try:
                for conn in user.usersourceconnection_set.all():
                    source_slugs.append(conn.source.slug)
            except Exception:
                pass

            # Admins get full access
            if user.is_superuser:
                groups.append("bookstack-uid-full-access")
            # Plex users get media-only access (slug: media-server-access)
            elif "media-server-access" in source_slugs:
                groups.append("bookstack-plex-media-users")
            # UID users get full access
            elif "unifi-identity-enterprise" in source_slugs:
                groups.append("bookstack-uid-full-access")
            # Direct Authentik login users get extended access
            else:
                groups.append("bookstack-extended-users")

            return {"groups": groups}
      - model: authentik_providers_oauth2.scopemapping
        id: scope-openwebui-groups
        identifiers:
          name: Open WebUI Groups
        attrs:
          name: Open WebUI Groups
          scope_name: groups
          description: "Returns user's Authentik group memberships for Open WebUI access control"
          expression: |
            # Return user's Authentik group names for Open WebUI
            return {"groups": [group.name for group in user.ak_groups.all()]}

  # =============================================================
  # OAUTH2 PROVIDERS BLUEPRINT
  # Direct OIDC providers for Open WebUI, BookStack, LiteLLM
  # =============================================================
  providers-oauth2.yaml: |
    version: 1
    metadata:
      name: OAuth2 Providers
      labels:
        blueprints.goauthentik.io/description: "OAuth2/OIDC providers for homelab applications"
    context:
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, "authentik Self-signed Certificate"]]
      scope_email: !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-email]]
      scope_profile: !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-profile]]
      scope_openid: !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-openid]]
      scope_offline: !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-offline_access]]
      scope_openwebui_groups: !Find [authentik_providers_oauth2.scopemapping, [name, "Open WebUI Groups"]]
      scope_bookstack_groups: !Find [authentik_providers_oauth2.scopemapping, [name, "BookStack Groups"]]
    entries:
      # Open WebUI - Direct OIDC
      - model: authentik_providers_oauth2.oauth2provider
        id: provider-openwebui
        identifiers:
          name: Open WebUI
        attrs:
          name: Open WebUI
          client_id: !Env AUTHENTIK_OPENWEBUI_CLIENT_ID
          client_secret: !Env AUTHENTIK_OPENWEBUI_CLIENT_SECRET
          client_type: confidential
          authorization_flow: !Context authorization_flow
          invalidation_flow: !Context invalidation_flow
          signing_key: !Context signing_key
          property_mappings:
            - !Context scope_openwebui_groups
            - !Context scope_email
            - !Context scope_profile
            - !Context scope_openid
          redirect_uris:
            - matching_mode: strict
              url: https://ai.homelab0.org/oauth/oidc/callback
          access_code_validity: minutes=1
          access_token_validity: minutes=5
          refresh_token_validity: days=30
          include_claims_in_id_token: true
          sub_mode: hashed_user_id
          issuer_mode: per_provider
      # BookStack - Direct OIDC
      - model: authentik_providers_oauth2.oauth2provider
        id: provider-bookstack
        identifiers:
          name: BookStack
        attrs:
          name: BookStack
          client_id: !Env AUTHENTIK_BOOKSTACK_CLIENT_ID
          client_secret: !Env AUTHENTIK_BOOKSTACK_CLIENT_SECRET
          client_type: confidential
          authorization_flow: !Context authorization_flow
          invalidation_flow: !Context invalidation_flow
          signing_key: !Context signing_key
          property_mappings:
            - !Context scope_bookstack_groups
            - !Context scope_email
            - !Context scope_profile
            - !Context scope_openid
          redirect_uris:
            - matching_mode: strict
              url: https://guides.homelab0.org/oidc/callback
          access_code_validity: minutes=1
          access_token_validity: minutes=5
          refresh_token_validity: days=30
          include_claims_in_id_token: true
          sub_mode: hashed_user_id
          issuer_mode: per_provider
      # LiteLLM - Direct OIDC (secret updated 2026-01-17)
      - model: authentik_providers_oauth2.oauth2provider
        id: provider-litellm
        identifiers:
          name: LiteLLM
        attrs:
          name: LiteLLM
          client_id: !Env AUTHENTIK_LITELLM_CLIENT_ID
          client_secret: !Env AUTHENTIK_LITELLM_CLIENT_SECRET
          client_type: confidential
          authorization_flow: !Context authorization_flow
          invalidation_flow: !Context invalidation_flow
          signing_key: !Context signing_key
          property_mappings:
            - !Context scope_email
            - !Context scope_profile
            - !Context scope_openid
          redirect_uris:
            - matching_mode: strict
              url: https://ai-api.homelab0.org/sso/callback
          access_code_validity: minutes=1
          access_token_validity: minutes=5
          refresh_token_validity: days=30
          include_claims_in_id_token: true
          sub_mode: hashed_user_id
          issuer_mode: per_provider
      # ToolHive - Direct OIDC (MCP Platform UI)
      - model: authentik_providers_oauth2.oauth2provider
        id: provider-toolhive
        identifiers:
          name: ToolHive
        attrs:
          name: ToolHive
          client_id: !Env AUTHENTIK_TOOLHIVE_CLIENT_ID
          client_secret: !Env AUTHENTIK_TOOLHIVE_CLIENT_SECRET
          client_type: confidential
          authorization_flow: !Context authorization_flow
          invalidation_flow: !Context invalidation_flow
          signing_key: !Context signing_key
          property_mappings:
            - !Context scope_email
            - !Context scope_profile
            - !Context scope_openid
          redirect_uris:
            - matching_mode: strict
              url: https://mcp.homelab0.org/api/auth/callback/oidc
          access_code_validity: minutes=1
          access_token_validity: minutes=5
          refresh_token_validity: days=30
          include_claims_in_id_token: true
          sub_mode: hashed_user_id
          issuer_mode: per_provider

  # =============================================================
  # PROXY PROVIDERS BLUEPRINT
  # Forward auth providers for n8n, Wizarr
  # =============================================================
  providers-proxy.yaml: |
    version: 1
    metadata:
      name: Proxy Providers
      labels:
        blueprints.goauthentik.io/description: "Forward auth proxy providers for embedded outpost"
    context:
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
      scope_proxy: !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/proxy/scope-proxy]]
      scope_email: !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-email]]
      scope_profile: !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-profile]]
      scope_openid: !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-openid]]
      scope_entitlements: !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-entitlements]]
    entries:
      # n8n - Forward Auth
      - model: authentik_providers_proxy.proxyprovider
        id: proxy-n8n
        identifiers:
          name: n8n
        attrs:
          name: n8n
          mode: forward_single
          external_host: https://n8n.homelab0.org
          authorization_flow: !Context authorization_flow
          invalidation_flow: !Context invalidation_flow
          property_mappings:
            - !Context scope_proxy
            - !Context scope_email
            - !Context scope_profile
            - !Context scope_openid
            - !Context scope_entitlements
          access_token_validity: hours=24
          refresh_token_validity: days=30
          intercept_header_auth: true
          internal_host_ssl_validation: true
      # Wizarr - Forward Auth (with skip paths for public invite links)
      - model: authentik_providers_proxy.proxyprovider
        id: proxy-wizarr
        identifiers:
          name: Wizarr
        attrs:
          name: Wizarr
          mode: forward_single
          external_host: https://wizarr.homelab0.org
          authorization_flow: !Context authorization_flow
          invalidation_flow: !Context invalidation_flow
          property_mappings:
            - !Context scope_proxy
            - !Context scope_email
            - !Context scope_profile
            - !Context scope_openid
            - !Context scope_entitlements
          access_token_validity: hours=24
          refresh_token_validity: days=30
          intercept_header_auth: true
          internal_host_ssl_validation: true
          skip_path_regex: |
            ^/join($|/.*)
            ^/j($|/.*)
            ^/static($|/.*)
            ^/setup($|/.*)
            ^/wizard($|/.*)
            ^/image-proxy($|/.*)
            ^/cinema-posters($|/.*)

  # =============================================================
  # APPLICATIONS BLUEPRINT
  # Applications using managed providers
  # =============================================================
  applications.yaml: |
    version: 1
    metadata:
      name: Applications
      labels:
        blueprints.goauthentik.io/description: "Homelab applications with SSO"
    entries:
      # Direct OIDC Applications
      - model: authentik_core.application
        id: app-openwebui
        identifiers:
          slug: open-webui
        attrs:
          name: Open WebUI
          slug: open-webui
          group: AI
          policy_engine_mode: any
          provider: !Find [authentik_providers_oauth2.oauth2provider, [name, "Open WebUI"]]
      - model: authentik_core.application
        id: app-bookstack
        identifiers:
          slug: book-stack
        attrs:
          name: BookStack
          slug: book-stack
          group: Tools
          policy_engine_mode: any
          provider: !Find [authentik_providers_oauth2.oauth2provider, [name, "BookStack"]]
      - model: authentik_core.application
        id: app-litellm
        identifiers:
          slug: lite-llm
        attrs:
          name: LiteLLM
          slug: lite-llm
          group: AI
          policy_engine_mode: any
          provider: !Find [authentik_providers_oauth2.oauth2provider, [name, "LiteLLM"]]
      - model: authentik_core.application
        id: app-toolhive
        identifiers:
          slug: toolhive
        attrs:
          name: ToolHive
          slug: toolhive
          group: AI
          policy_engine_mode: any
          provider: !Find [authentik_providers_oauth2.oauth2provider, [name, "ToolHive"]]
      # Forward Auth Applications
      - model: authentik_core.application
        id: app-n8n
        identifiers:
          slug: n8n
        attrs:
          name: n8n
          slug: n8n
          group: Tools
          policy_engine_mode: any
          provider: !Find [authentik_providers_proxy.proxyprovider, [name, "n8n"]]
      - model: authentik_core.application
        id: app-wizarr
        identifiers:
          slug: wizarr
        attrs:
          name: Wizarr
          slug: wizarr
          group: Media
          policy_engine_mode: any
          provider: !Find [authentik_providers_proxy.proxyprovider, [name, "Wizarr"]]

  # =============================================================
  # SOURCES BLUEPRINT
  # External authentication sources (Plex, UID)
  # =============================================================
  sources.yaml: |
    version: 1
    metadata:
      name: Authentication Sources
      labels:
        blueprints.goauthentik.io/description: "External authentication sources for homelab"
    context:
      authentication_flow: !Find [authentik_flows.flow, [slug, default-source-authentication]]
      enrollment_flow: !Find [authentik_flows.flow, [slug, default-source-enrollment]]
    entries:
      # Plex Source
      - model: authentik_sources_plex.plexsource
        id: source-plex
        identifiers:
          slug: media-server-access
        attrs:
          name: Sign in with Plex
          slug: media-server-access
          enabled: true
          authentication_flow: !Context authentication_flow
          enrollment_flow: !Context enrollment_flow
          policy_engine_mode: any
          user_matching_mode: identifier
          group_matching_mode: identifier
          user_path_template: goauthentik.io/sources/%(slug)s
          client_id: !Env AUTHENTIK_PLEX_CLIENT_ID
          plex_token: !Env AUTHENTIK_PLEX_TOKEN
          allow_friends: true
          allowed_servers:
            - !Env AUTHENTIK_PLEX_SERVER_ID
      # UniFi Identity Enterprise Source
      - model: authentik_sources_oauth.oauthsource
        id: source-uid
        identifiers:
          slug: unifi-identity-enterprise
        attrs:
          name: Sign in with UID
          slug: unifi-identity-enterprise
          enabled: true
          authentication_flow: !Context authentication_flow
          enrollment_flow: !Context enrollment_flow
          policy_engine_mode: any
          user_matching_mode: email_link
          group_matching_mode: identifier
          provider_type: openidconnect
          consumer_key: !Env AUTHENTIK_UID_CONSUMER_KEY
          consumer_secret: !Env AUTHENTIK_UID_CONSUMER_SECRET
