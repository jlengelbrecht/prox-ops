name: Setup Cluster Tools
description: Install tools from mise (version-controlled) and configure kubeconfig for cluster access
inputs:
  talosconfig:
    description: Base64-encoded Talos/Kubernetes config
    required: true
  working-directory:
    description: Directory containing .mise.toml (defaults to repository root)
    required: false
    default: '.'

runs:
  using: composite
  steps:
    # mise-action reads .mise.toml but we only install CI-essential tools
    # to avoid filling disk with unnecessary packages (Python 3.14 is ~500MB)
    - name: Setup mise and install tools
      uses: jdx/mise-action@v2
      with:
        cache: true
        working_directory: ${{ inputs.working-directory }}
        # Only install tools needed for CI workflows (not full .mise.toml)
        # This prevents disk space exhaustion on cattle-runner
        install_args: "aqua:kubernetes/kubectl aqua:siderolabs/talos aqua:fluxcd/flux2 aqua:helm/helm aqua:jqlang/jq aqua:mikefarah/yq aqua:kubernetes-sigs/kustomize"

    - name: Verify tool versions
      shell: bash
      run: |
        echo "============================================"
        echo "Installed tool versions (CI-essential subset):"
        echo "============================================"

        # Verify critical tools are present (fail fast if missing)
        if ! command -v kubectl &>/dev/null; then
          echo "❌ ERROR: kubectl not found - check install_args"
          exit 1
        fi
        if ! command -v talosctl &>/dev/null; then
          echo "❌ ERROR: talosctl not found - check install_args"
          exit 1
        fi

        echo "  kubectl:   $(kubectl version --client -o json 2>/dev/null | jq -r '.clientVersion.gitVersion' || kubectl version --client 2>&1 | head -1)"
        echo "  talosctl:  $(talosctl version --client --short 2>/dev/null | grep Tag | awk '{print $2}' || echo 'version check failed')"
        echo "  flux:      $(flux version --client 2>/dev/null | head -1 || echo 'not available')"
        echo "  helm:      $(helm version --short 2>/dev/null || echo 'not available')"
        echo "  kustomize: $(kustomize version 2>/dev/null || echo 'not available')"
        echo "  yq:        $(yq --version 2>/dev/null || echo 'not available')"
        echo "  jq:        $(jq --version 2>/dev/null || echo 'not available')"
        echo "============================================"

    - name: Setup kubeconfig
      shell: bash
      run: |
        # Save talosconfig
        mkdir -p "$HOME/.talos"
        echo "${{ inputs.talosconfig }}" | base64 -d > "$HOME/.talos/config"
        chmod 600 "$HOME/.talos/config"

        # Generate kubeconfig from talosconfig with resilient control plane fallback
        # Try each control plane node until one succeeds (handles node maintenance/upgrades)
        mkdir -p "$HOME/.kube"

        CONTROL_PLANE_IPS=("10.20.67.1" "10.20.67.2" "10.20.67.3")
        KUBECONFIG_GENERATED=false

        for NODE_IP in "${CONTROL_PLANE_IPS[@]}"; do
          echo "Attempting kubeconfig generation from control plane node: $NODE_IP"

          if talosctl kubeconfig \
            --talosconfig="$HOME/.talos/config" \
            --nodes="$NODE_IP" \
            --merge=false \
            --force \
            "$HOME/.kube/config" 2>&1; then

            echo "✅ Successfully generated kubeconfig from $NODE_IP"
            chmod 600 "$HOME/.kube/config"
            KUBECONFIG_GENERATED=true
            break
          else
            echo "⚠️  Failed to reach $NODE_IP, trying next control plane node..."
          fi
        done

        # Verify kubeconfig was generated from at least one control plane
        if [[ "$KUBECONFIG_GENERATED" != "true" ]]; then
          echo "❌ ERROR: Failed to generate kubeconfig from any control plane node"
          echo "Tried nodes: ${CONTROL_PLANE_IPS[*]}"
          exit 1
        fi

        # Verify kubeconfig is valid
        echo "Verifying kubeconfig..."
        kubectl config view --minify

        # Verify cluster connectivity
        echo "Testing cluster API connectivity..."
        if ! kubectl version --short &>/dev/null; then
          echo "⚠️  WARNING: Generated kubeconfig is valid but cannot reach API server"
          echo "This may indicate network issues or cluster being upgraded"
          exit 1
        fi
        echo "✅ Cluster API server is reachable"
