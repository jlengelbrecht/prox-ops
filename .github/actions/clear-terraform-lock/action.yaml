name: Clear Terraform State Lock
description: Multi-layer Terraform state lock clearing with age validation and S3 fallback
inputs:
  terraform_state_bucket:
    description: S3 bucket name containing Terraform state
    required: true
  terraform_state_key:
    description: S3 state file key (e.g., terraform.tfstate)
    required: false
    default: terraform.tfstate
  proxmox_username:
    description: Proxmox username for Terraform authentication
    required: true
  proxmox_password:
    description: Proxmox password/token for Terraform authentication
    required: true
  github_repository:
    description: GitHub repository name for error messages
    required: true

runs:
  using: composite
  steps:
    - name: Clear stale Terraform locks
      shell: bash
      working-directory: ./terraform
      env:
        TF_VAR_proxmox_username: ${{ inputs.proxmox_username }}
        TF_VAR_proxmox_password: ${{ inputs.proxmox_password }}
      run: |
        echo "Checking for Terraform state lock in S3..."
        echo ""

        # Fast check: Query S3 directly for lock file (< 1 second vs 3+ minutes for terraform plan)
        # S3 lock file: <state-key>.lock.info contains lock metadata as JSON
        # Lock file path is derived from the state file key (e.g., terraform.tfstate → terraform.tfstate.lock.info)
        LOCK_FILE="s3://${{ inputs.terraform_state_bucket }}/${{ inputs.terraform_state_key }}.lock.info"
        BUCKET="${{ inputs.terraform_state_bucket }}"
        KEY="${{ inputs.terraform_state_key }}.lock.info"

        # Validate state key to prevent path traversal and injection
        STATE_KEY="${{ inputs.terraform_state_key }}"
        if [[ "$STATE_KEY" =~ \.\.|^/|// ]]; then
          echo "::error::Invalid terraform_state_key: contains path traversal characters"
          echo "::error::State key must not contain '..' or leading/double slashes"
          echo "::error::Provided: $STATE_KEY"
          exit 1
        fi

        if [[ ! "$STATE_KEY" =~ ^[a-zA-Z0-9._/-]+$ ]]; then
          echo "::error::Invalid terraform_state_key: contains unsafe characters"
          echo "::error::Allowed: alphanumerics, dots, underscores, hyphens, forward slashes"
          echo "::error::Provided: $STATE_KEY"
          exit 1
        fi

        echo "Checking for lock file at: $LOCK_FILE"

        # Try multiple detection methods (some locks are invisible to 'ls' but block operations)
        LOCK_EXISTS=false

        # Method 1: aws s3 ls (fast but may miss corrupted locks)
        if aws s3 ls "$LOCK_FILE" 2>/dev/null; then
          echo "✓ Lock detected via 's3 ls'"
          LOCK_EXISTS=true
        fi

        # Method 2: aws s3api head-object (more reliable, uses different API)
        if ! $LOCK_EXISTS; then
          if aws s3api head-object --bucket "$BUCKET" --key "$KEY" 2>/dev/null; then
            echo "✓ Lock detected via 's3api head-object' (invisible to ls)"
            LOCK_EXISTS=true
          fi
        fi

        # Method 3: Try to download lock content (definitive test)
        if ! $LOCK_EXISTS; then
          if LOCK_INFO=$(aws s3 cp "$LOCK_FILE" - 2>/dev/null) && [ -n "$LOCK_INFO" ]; then
            echo "✓ Lock detected via 's3 cp' (can download content)"
            LOCK_EXISTS=true
          fi
        fi

        if ! $LOCK_EXISTS; then
          echo "✓ No lock detected - state is accessible"
          echo "  Checked with: s3 ls, s3api head-object, s3 cp"
          exit 0
        fi

        echo "⚠️  Lock file detected in S3"
        echo ""

        # Download lock info and parse JSON (may already have it from Method 3)
        if [ -z "${LOCK_INFO:-}" ]; then
          LOCK_INFO=$(aws s3 cp "$LOCK_FILE" - 2>/dev/null)
        fi

        if [ -z "$LOCK_INFO" ]; then
          echo "::error::Could not download lock file contents"
          exit 1
        fi

        echo "Lock details:"
        echo "$LOCK_INFO" | jq '.'
        echo ""

        # Extract lock metadata
        LOCK_ID=$(echo "$LOCK_INFO" | jq -r '.ID // empty')
        LOCK_CREATED=$(echo "$LOCK_INFO" | jq -r '.Created // empty')
        LOCK_WHO=$(echo "$LOCK_INFO" | jq -r '.Who // "unknown"')
        LOCK_OPERATION=$(echo "$LOCK_INFO" | jq -r '.Operation // "unknown"')

        if [ -z "$LOCK_ID" ]; then
          echo "::error::Could not extract lock ID from lock file"
          echo "::error::Lock file may be corrupted - attempting direct S3 deletion"
          aws s3 rm "$LOCK_FILE" --only-show-errors
          sleep 2
          if aws s3 ls "$LOCK_FILE" 2>/dev/null; then
            echo "::error::Failed to remove corrupted lock file"
            exit 1
          fi
          echo "✓ Corrupted lock file removed"
          exit 0
        fi

        # Calculate lock age (POSIX-portable with fallback)
        CURRENT_TIME=$(date -u +%s)

        # Try GNU date first, fall back to Python if unavailable
        if LOCK_TIME=$(date -u -d "$LOCK_CREATED" +%s 2>/dev/null); then
          : # GNU date succeeded
        elif command -v python3 &>/dev/null; then
          # Use Python for POSIX systems without GNU date
          LOCK_TIME=$(python3 -c "import sys,datetime; print(int(datetime.datetime.fromisoformat(sys.argv[1].replace('Z','+00:00')).timestamp()))" "$LOCK_CREATED" 2>/dev/null || echo "")
          if [ -z "$LOCK_TIME" ]; then
            echo "::error::Failed to parse lock timestamp: $LOCK_CREATED"
            echo "::error::Both GNU date and Python parsing failed"
            exit 1
          fi
        else
          echo "::error::Cannot parse lock timestamp - neither GNU date nor python3 available"
          exit 1
        fi

        LOCK_AGE_MINUTES=$(( (CURRENT_TIME - LOCK_TIME) / 60 ))

        echo "Lock analysis:"
        echo "  ID: $LOCK_ID"
        echo "  Created: $LOCK_CREATED"
        echo "  Age: $LOCK_AGE_MINUTES minutes"
        echo "  Owner: $LOCK_WHO"
        echo "  Operation: $LOCK_OPERATION"
        echo ""

        # SAFETY: Only clear locks > 5 minutes old
        MIN_AGE=5
        if [ "$LOCK_AGE_MINUTES" -lt "$MIN_AGE" ]; then
          echo "::error::=========================================="
          echo "::error::LOCK TOO RECENT - POSSIBLE ACTIVE OPERATION"
          echo "::error::=========================================="
          echo "::error::"
          echo "::error::Lock is only $LOCK_AGE_MINUTES minutes old (threshold: $MIN_AGE minutes)"
          echo "::error::Another operation may be legitimately in progress"
          echo "::error::"
          echo "::error::Check for concurrent workflows:"
          echo "::error::  https://github.com/${{ inputs.github_repository }}/actions"
          echo "::error::"
          echo "::error::If you're certain the lock is stale, manually remove it:"
          echo "::error::  aws s3 rm s3://${{ inputs.terraform_state_bucket }}/${{ inputs.terraform_state_key }}.lock.info"
          echo "::error::=========================================="
          exit 1
        fi

        echo "Lock is $LOCK_AGE_MINUTES minutes old - safe to clear"
        echo ""

        # LAYER 1: Try terraform force-unlock
        echo "Attempting terraform force-unlock..."
        if terraform force-unlock -force "$LOCK_ID" 2>&1; then
          echo "✓ terraform force-unlock command succeeded"
        else
          echo "⚠️  terraform force-unlock command failed (may be expected)"
        fi

        # LAYER 2: Verify lock is actually gone from S3
        echo ""
        echo "Verifying lock removal from S3..."
        sleep 2  # S3 eventual consistency

        if ! aws s3 ls "$LOCK_FILE" 2>/dev/null; then
          echo "✓ Lock successfully removed"
          exit 0
        fi

        # LAYER 3: terraform force-unlock didn't remove S3 file - do it manually
        echo "⚠️  terraform force-unlock succeeded but S3 lock file still exists!"
        echo "This is a known issue with S3 backend - removing file directly..."
        echo ""

        # Try multiple deletion methods for stubborn locks
        DELETION_SUCCEEDED=false

        # Method 1: aws s3 rm (standard deletion)
        if aws s3 rm "$LOCK_FILE" --only-show-errors 2>/dev/null; then
          echo "✓ S3 lock file removed via 's3 rm'"
          DELETION_SUCCEEDED=true
        else
          echo "⚠️  's3 rm' failed, trying alternative method..."
        fi

        # Method 2: aws s3api delete-object (low-level API, may work for corrupted files)
        if ! $DELETION_SUCCEEDED; then
          if aws s3api delete-object --bucket "$BUCKET" --key "$KEY" 2>/dev/null; then
            echo "✓ S3 lock file removed via 's3api delete-object'"
            DELETION_SUCCEEDED=true
          else
            echo "⚠️  's3api delete-object' also failed"
          fi
        fi

        if ! $DELETION_SUCCEEDED; then
          echo "::error::Failed to remove S3 lock file via all methods"
          echo "::error::Tried: s3 rm, s3api delete-object"
          exit 1
        fi

        # LAYER 4: Final verification using multi-method approach
        echo ""
        echo "Final verification: Ensuring lock is truly gone..."
        sleep 3  # S3 eventual consistency

        LOCK_STILL_EXISTS=false

        # Check with all methods
        if aws s3 ls "$LOCK_FILE" 2>/dev/null; then
          LOCK_STILL_EXISTS=true
          echo "⚠️  Lock still visible via 's3 ls'"
        fi

        if ! $LOCK_STILL_EXISTS && aws s3api head-object --bucket "$BUCKET" --key "$KEY" 2>/dev/null; then
          LOCK_STILL_EXISTS=true
          echo "⚠️  Lock still visible via 's3api head-object'"
        fi

        if ! $LOCK_STILL_EXISTS && aws s3 cp "$LOCK_FILE" - 2>/dev/null >/dev/null; then
          LOCK_STILL_EXISTS=true
          echo "⚠️  Lock still downloadable via 's3 cp'"
        fi

        if $LOCK_STILL_EXISTS; then
          echo "::error::=========================================="
          echo "::error::LOCK REMOVAL FAILED"
          echo "::error::=========================================="
          echo "::error::"
          echo "::error::Lock file persists after multiple removal attempts"
          echo "::error::Tried deletion methods: s3 rm, s3api delete-object"
          echo "::error::Tried verification methods: s3 ls, s3api head-object, s3 cp"
          echo "::error::"
          echo "::error::Lock ID: $LOCK_ID"
          echo "::error::Lock Age: $LOCK_AGE_MINUTES minutes"
          echo "::error::Lock Owner: $LOCK_WHO"
          echo "::error::"
          echo "::error::This indicates an S3 bucket configuration issue:"
          echo "::error::  - Object lock/WORM may be enabled"
          echo "::error::  - S3 versioning with protected delete markers"
          echo "::error::  - IAM permissions may not allow deletion"
          echo "::error::  - Corrupted S3 object metadata"
          echo "::error::"
          echo "::error::Manual investigation of S3 bucket required"
          echo "::error::=========================================="
          exit 1
        fi

        echo "✓ Lock successfully cleared and verified (checked with all methods)"
