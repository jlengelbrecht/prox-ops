name: Test Secrets Access

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test AWS Secrets
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          echo "=== AWS Credentials ==="
          if [ -z "$AWS_ACCESS_KEY_ID" ]; then
            echo "❌ AWS_ACCESS_KEY_ID not set"
            exit 1
          fi
          echo "✅ AWS_ACCESS_KEY_ID loaded (length: ${#AWS_ACCESS_KEY_ID} chars)"

          if [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "❌ AWS_SECRET_ACCESS_KEY not set"
            exit 1
          fi
          echo "✅ AWS_SECRET_ACCESS_KEY loaded (length: ${#AWS_SECRET_ACCESS_KEY} chars)"

          if [ -z "$AWS_DEFAULT_REGION" ]; then
            echo "❌ AWS_DEFAULT_REGION not set"
            exit 1
          fi
          echo "✅ AWS_DEFAULT_REGION loaded (length: ${#AWS_DEFAULT_REGION} chars)"
          echo ""

      - name: Test Proxmox Secrets
        env:
          PROXMOX_USERNAME: ${{ secrets.PROXMOX_USERNAME }}
          PROXMOX_PASSWORD: ${{ secrets.PROXMOX_PASSWORD }}
        run: |
          echo "=== Proxmox Credentials ==="
          if [ -z "$PROXMOX_USERNAME" ]; then
            echo "❌ PROXMOX_USERNAME not set"
            exit 1
          fi
          echo "✅ PROXMOX_USERNAME loaded (length: ${#PROXMOX_USERNAME} chars)"

          if [ -z "$PROXMOX_PASSWORD" ]; then
            echo "❌ PROXMOX_PASSWORD not set"
            exit 1
          fi
          echo "✅ PROXMOX_PASSWORD loaded (length: ${#PROXMOX_PASSWORD} chars)"
          echo ""

      - name: Test Talos Config
        env:
          TALOSCONFIG: ${{ secrets.TALOSCONFIG }}
        run: |
          echo "=== Talos Configuration ==="
          if [ -z "$TALOSCONFIG" ]; then
            echo "❌ TALOSCONFIG not set"
            exit 1
          fi

          # Decode and validate in-memory (no temp file, no stored variable)
          # Check if it's valid YAML (basic check)
          if echo "$TALOSCONFIG" | base64 -d | grep -q "context:"; then
            echo "✅ TALOSCONFIG loaded and decoded successfully"
            echo "   Size: $(echo "$TALOSCONFIG" | wc -c) bytes (base64)"
            echo "   Decoded size: $(echo "$TALOSCONFIG" | base64 -d | wc -c) bytes"
          else
            echo "❌ TALOSCONFIG decode failed or invalid format"
            exit 1
          fi
          echo ""

      - name: Test GitHub App Secrets
        env:
          GITHUB_APP_ID: ${{ secrets.GITHUB_APP_ID }}
          BOT_APP_ID: ${{ secrets.BOT_APP_ID }}
          BOT_APP_INSTALLATION_ID: ${{ secrets.BOT_APP_INSTALLATION_ID }}
          GITHUB_APP_PRIVATE_KEY: ${{ secrets.GITHUB_APP_PRIVATE_KEY }}
          BOT_APP_PRIVATE_KEY: ${{ secrets.BOT_APP_PRIVATE_KEY }}
        run: |
          echo "=== GitHub App Credentials ==="

          # Check for GITHUB_APP_ID or BOT_APP_ID
          if [ -n "$GITHUB_APP_ID" ]; then
            echo "✅ GITHUB_APP_ID loaded (length: ${#GITHUB_APP_ID} chars)"
          elif [ -n "$BOT_APP_ID" ]; then
            echo "✅ BOT_APP_ID loaded (length: ${#BOT_APP_ID} chars) - maps to GITHUB_APP_ID"
          else
            echo "❌ Neither GITHUB_APP_ID nor BOT_APP_ID set"
            exit 1
          fi

          if [ -z "$BOT_APP_INSTALLATION_ID" ]; then
            echo "⚠️  BOT_APP_INSTALLATION_ID not set (required for Story 3: Self-Hosted Runners)"
          else
            echo "✅ BOT_APP_INSTALLATION_ID loaded (length: ${#BOT_APP_INSTALLATION_ID} chars)"
          fi

          # Check for GITHUB_APP_PRIVATE_KEY or BOT_APP_PRIVATE_KEY
          if [ -n "$GITHUB_APP_PRIVATE_KEY" ]; then
            echo "✅ GITHUB_APP_PRIVATE_KEY loaded (length: ${#GITHUB_APP_PRIVATE_KEY} chars)"
          elif [ -n "$BOT_APP_PRIVATE_KEY" ]; then
            echo "✅ BOT_APP_PRIVATE_KEY loaded (length: ${#BOT_APP_PRIVATE_KEY} chars) - maps to GITHUB_APP_PRIVATE_KEY"
          else
            echo "❌ Neither GITHUB_APP_PRIVATE_KEY nor BOT_APP_PRIVATE_KEY set"
            exit 1
          fi
          echo ""

      - name: Test Discord Webhook (Optional)
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "=== Discord Webhook ==="
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "⚠️  DISCORD_WEBHOOK_URL not set (optional - upgrade notifications disabled)"
          else
            echo "✅ DISCORD_WEBHOOK_URL loaded (length: ${#DISCORD_WEBHOOK_URL} chars)"

            # Validate URL format without sending (dry-run)
            if [[ "$DISCORD_WEBHOOK_URL" =~ ^https://discord(app)?\.com/api/webhooks/ ]]; then
              echo "   URL format valid (Discord webhook)"
            else
              echo "⚠️  URL format unexpected - may not be a valid Discord webhook"
            fi

            # Uncomment to test actual webhook delivery
            # curl -X POST "$DISCORD_WEBHOOK_URL" \
            #   -H "Content-Type: application/json" \
            #   -d '{"content": "✅ GitHub Actions secrets test successful! (STORY-040)"}' \
            #   || echo "⚠️  Webhook request failed - check URL validity"
          fi
          echo ""

      - name: Summary
        run: |
          echo "=========================================="
          echo "Secret Access Test Summary"
          echo "=========================================="
          echo ""
          echo "✅ All critical secrets loaded successfully!"
          echo ""
          echo "Configured secrets:"
          echo "  ✅ AWS_ACCESS_KEY_ID"
          echo "  ✅ AWS_SECRET_ACCESS_KEY"
          echo "  ✅ AWS_DEFAULT_REGION"
          echo "  ✅ PROXMOX_USERNAME"
          echo "  ✅ PROXMOX_PASSWORD"
          echo "  ✅ TALOSCONFIG"
          echo "  ✅ GITHUB_APP_ID (or BOT_APP_ID)"
          echo "  ✅ GITHUB_APP_PRIVATE_KEY (or BOT_APP_PRIVATE_KEY)"
          echo "  ✅ BOT_APP_INSTALLATION_ID"
          echo ""
          echo "Next steps:"
          echo "  1. Verify secret masking in workflow logs (values should show as ***)"
          echo "  2. Check audit log: Settings → Logs → Audit log → Filter: action:repo.secret"
          echo "  3. If Discord webhook desired, uncomment webhook test and add DISCORD_WEBHOOK_URL"
          echo "  4. Delete this test workflow after validation (temporary testing only)"
          echo "  5. Mark STORY-002 (GitHub Actions Secrets Setup) as complete"
          echo ""
          echo "=========================================="
