---
name: Talos Version Router

on:
  push:
    branches:
      - main
    paths:
      - terraform/variables.tf
  workflow_dispatch:
    inputs:
      test_mode:
        description: Test mode (only 2 workers, skip control plane)
        type: boolean
        default: true
      force_cattle:
        description: Force cattle upgrade (skip version detection)
        type: boolean
        default: false

jobs:
  detect-version-change:
    name: Detect Version Change
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.detect.outputs.version_changed }}
      old_version: ${{ steps.detect.outputs.old_version }}
      new_version: ${{ steps.detect.outputs.new_version }}
      upgrade_type: ${{ steps.detect.outputs.upgrade_type }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need 2 commits to compare

      - name: Detect version change
        id: detect
        run: |
          set -euo pipefail

          # Extract old version from previous commit
          OLD_VERSION=$(git show HEAD^:terraform/variables.tf | grep -A3 'variable "talos_version"' | grep 'default' | cut -d'"' -f2)

          # Extract new version from current commit
          NEW_VERSION=$(git show HEAD:terraform/variables.tf | grep -A3 'variable "talos_version"' | grep 'default' | cut -d'"' -f2)

          # SECURITY: Validate version format (semver only: digits.digits.digits)
          if ! [[ "$OLD_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid old version format: '$OLD_VERSION' (expected semver X.Y.Z)"
            exit 1
          fi

          if ! [[ "$NEW_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid new version format: '$NEW_VERSION' (expected semver X.Y.Z)"
            exit 1
          fi

          echo "Old version: $OLD_VERSION"
          echo "New version: $NEW_VERSION"

          # Check if version changed
          if [[ "$OLD_VERSION" == "$NEW_VERSION" ]]; then
            echo "version_changed=false" >> $GITHUB_OUTPUT
            echo "No version change detected"
            exit 0
          fi

          echo "version_changed=true" >> $GITHUB_OUTPUT
          echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Parse semantic version components
          OLD_MAJOR=$(echo $OLD_VERSION | cut -d. -f1)
          OLD_MINOR=$(echo $OLD_VERSION | cut -d. -f2)
          OLD_PATCH=$(echo $OLD_VERSION | cut -d. -f3)

          NEW_MAJOR=$(echo $NEW_VERSION | cut -d. -f1)
          NEW_MINOR=$(echo $NEW_VERSION | cut -d. -f2)
          NEW_PATCH=$(echo $NEW_VERSION | cut -d. -f3)

          # Determine upgrade type
          if [[ "$OLD_MAJOR" != "$NEW_MAJOR" ]] || [[ "$OLD_MINOR" != "$NEW_MINOR" ]]; then
            UPGRADE_TYPE="cattle"
            echo "Detected MAJOR/MINOR upgrade: $OLD_VERSION → $NEW_VERSION"
            echo "Routing to: CATTLE workflow (destroy and recreate)"
          else
            UPGRADE_TYPE="pets"
            echo "Detected PATCH upgrade: $OLD_VERSION → $NEW_VERSION"
            echo "Routing to: PETS workflow (in-place upgrade)"
          fi

          echo "upgrade_type=$UPGRADE_TYPE" >> $GITHUB_OUTPUT

          # Output summary
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## Talos Version Change Detected

          **Old Version**: \`$OLD_VERSION\`
          **New Version**: \`$NEW_VERSION\`
          **Upgrade Type**: \`$UPGRADE_TYPE\`

          ### Version Analysis
          - Old: MAJOR=$OLD_MAJOR, MINOR=$OLD_MINOR, PATCH=$OLD_PATCH
          - New: MAJOR=$NEW_MAJOR, MINOR=$NEW_MINOR, PATCH=$NEW_PATCH

          ### Next Step
          $(if [[ "$UPGRADE_TYPE" == "cattle" ]]; then
            echo "Triggering **cattle** workflow (templates + VMs)"
          else
            echo "Triggering **pets** workflow (in-place talosctl upgrade)"
          fi)
          EOF

  route-to-cattle:
    name: Route to Cattle Workflow
    needs: detect-version-change
    if: needs.detect-version-change.outputs.version_changed == 'true' && needs.detect-version-change.outputs.upgrade_type == 'cattle'
    uses: ./.github/workflows/upgrade-cattle.yaml
    secrets: inherit
    with:
      old_version: ${{ needs.detect-version-change.outputs.old_version }}
      new_version: ${{ needs.detect-version-change.outputs.new_version }}
      test_mode: ${{ inputs.test_mode || true }}

  route-to-pets:
    name: Route to Pets Workflow (Templates Only)
    needs: detect-version-change
    if: needs.detect-version-change.outputs.version_changed == 'true' && needs.detect-version-change.outputs.upgrade_type == 'pets'
    uses: ./.github/workflows/upgrade-cattle.yaml
    secrets: inherit
    with:
      old_version: ${{ needs.detect-version-change.outputs.old_version }}
      new_version: ${{ needs.detect-version-change.outputs.new_version }}
      test_mode: false
      templates_only: true  # Only rebuild templates, skip VM upgrades
