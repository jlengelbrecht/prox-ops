---
# Build and publish coderabbitai-mcp Docker image
# Source: https://github.com/bradthebeeble/coderabbitai-mcp
name: Build CodeRabbit MCP Image

on:
  workflow_dispatch:
  schedule:
    # Weekly rebuild to pick up dependency updates
    - cron: "0 3 * * 0"
  push:
    paths:
      - ".github/workflows/build-coderabbitai-mcp.yaml"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/coderabbitai-mcp
  SOURCE_REPO: bradthebeeble/coderabbitai-mcp

jobs:
  build:
    # Use GitHub-hosted runners for Docker builds (K8s runners don't have Docker daemon)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout source repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ env.SOURCE_REPO }}
          ref: main

      - name: Get source commit SHA
        id: source
        run: |
          echo "sha=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          echo "date=$(date -u +%Y%m%d)" >> "$GITHUB_OUTPUT"

      - name: Fix Dockerfile
        run: |
          # Upstream Dockerfile has a bug: uses --only=production but needs devDependencies for build
          cat > Dockerfile << 'DOCKERFILE'
          FROM node:18-alpine

          WORKDIR /app

          # Copy package files
          COPY package*.json ./

          # Install ALL dependencies (including devDependencies for build)
          RUN npm ci

          # Copy source code
          COPY . .

          # Build the application
          RUN npm run build

          # Remove devDependencies after build
          RUN npm prune --production

          # Create non-root user
          RUN addgroup -g 1001 -S nodejs && \
              adduser -S nodejs -u 1001

          RUN chown -R nodejs:nodejs /app
          USER nodejs

          # MCP servers use stdio, not HTTP port
          CMD ["node", "dist/index.js"]
          DOCKERFILE

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@902fa8ec7d6ecbf8d84d538b9b233a880e428804 # v5.7.0
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.source.outputs.date }}-${{ steps.source.outputs.sha }}
            type=sha,prefix=

      - name: Build and push Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Output image details
        run: |
          echo "## Image Published" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Registry:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Tags:**" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "${{ steps.meta.outputs.tags }}" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Source:** ${{ env.SOURCE_REPO }}@${{ steps.source.outputs.sha }}" >> "$GITHUB_STEP_SUMMARY"
