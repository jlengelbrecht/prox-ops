---
# MCP Server Catalog Sync Workflow
# Automatically generates registry catalog entries from MCPServer CRD definitions
#
# Triggers when MCPServer files are added/modified in PRs
# Validates the MCPServer, checks security, and generates catalog entries
name: "MCP Catalog Sync"

on:
  pull_request:
    branches: ["main"]
    paths:
      - "kubernetes/apps/mcp/toolhive-gateway/app/mcpserver-*.yaml"
      - "kubernetes/apps/mcp/registry-data/registry.json"
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: "Force regenerate all catalog entries"
        required: false
        default: "false"
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

env:
  MCPSERVER_PATH: "kubernetes/apps/mcp/toolhive-gateway/app"
  REGISTRY_PATH: "kubernetes/apps/mcp/registry-data/registry.json"
  # renovate: datasource=github-releases depName=aquasecurity/trivy
  TRIVY_VERSION: "0.58.2"
  # renovate: datasource=github-releases depName=mikefarah/yq
  YQ_VERSION: "4.45.1"
  # SHA256 checksum for yq_linux_amd64 v4.45.1 (from official checksums.txt)
  YQ_CHECKSUM: "654d2943ca1d3be2024089eb4f270f4070f491a0610481d128d1b7c8b6c4a080"

jobs:
  # =============================================================================
  # Job 1: Pre-flight - Detect MCPServer changes
  # =============================================================================
  preflight:
    name: Detect MCP Changes
    runs-on: ubuntu-latest
    outputs:
      mcpservers_changed: ${{ steps.changed.outputs.mcpservers_changed }}
      mcpserver_files: ${{ steps.changed.outputs.mcpserver_files }}
      registry_changed: ${{ steps.changed.outputs.registry_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Detect Changed Files
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force_regenerate }}" = "true" ]; then
            echo "Force regenerate requested - processing all MCPServer files"
            MCPSERVER_FILES=$(find "${{ env.MCPSERVER_PATH }}" -name "mcpserver-*.yaml" -type f | sort)
            echo "mcpservers_changed=true" >> "$GITHUB_OUTPUT"
          else
            # Get changed files in PR
            CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
            MCPSERVER_FILES=$(echo "$CHANGED" | grep -E "^${{ env.MCPSERVER_PATH }}/mcpserver-.*\.yaml$" || true)
            REGISTRY_CHANGED=$(echo "$CHANGED" | grep -E "^${{ env.REGISTRY_PATH }}$" || true)

            if [ -n "$MCPSERVER_FILES" ]; then
              echo "mcpservers_changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "mcpservers_changed=false" >> "$GITHUB_OUTPUT"
            fi

            if [ -n "$REGISTRY_CHANGED" ]; then
              echo "registry_changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "registry_changed=false" >> "$GITHUB_OUTPUT"
            fi
          fi

          # Store files as JSON array for matrix
          if [ -n "$MCPSERVER_FILES" ]; then
            FILES_JSON=$(echo "$MCPSERVER_FILES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "mcpserver_files=$FILES_JSON" >> "$GITHUB_OUTPUT"
            echo "MCPServer files to process:"
            echo "$MCPSERVER_FILES"
          else
            echo "mcpserver_files=[]" >> "$GITHUB_OUTPUT"
            echo "No MCPServer files changed"
          fi

  # =============================================================================
  # Job 2: Validate MCPServer definitions
  # =============================================================================
  validate:
    name: Validate MCPServer
    needs: preflight
    if: needs.preflight.outputs.mcpservers_changed == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJson(needs.preflight.outputs.mcpserver_files) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install yq
        run: |
          # Download yq with checksum verification for supply chain security
          wget -qO /tmp/yq "https://github.com/mikefarah/yq/releases/download/v${{ env.YQ_VERSION }}/yq_linux_amd64"
          echo "${{ env.YQ_CHECKSUM }}  /tmp/yq" | sha256sum -c -
          sudo mv /tmp/yq /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Validate YAML Syntax
        run: |
          echo "Validating YAML syntax for: ${{ matrix.file }}"
          yq eval '.' "${{ matrix.file }}" > /dev/null
          echo "YAML syntax is valid"

      - name: Validate Required Fields
        id: validate-fields
        run: |
          FILE="${{ matrix.file }}"
          echo "Validating required fields in: $FILE"

          ERRORS=""

          # Required spec fields
          IMAGE=$(yq eval '.spec.image // ""' "$FILE")
          TRANSPORT=$(yq eval '.spec.transport // ""' "$FILE")
          NAME=$(yq eval '.metadata.name // ""' "$FILE")

          if [ -z "$IMAGE" ]; then
            ERRORS="${ERRORS}Missing required field: spec.image\n"
          fi

          if [ -z "$TRANSPORT" ]; then
            ERRORS="${ERRORS}Missing required field: spec.transport\n"
          fi

          if [ -z "$NAME" ]; then
            ERRORS="${ERRORS}Missing required field: metadata.name\n"
          fi

          # Catalog annotation requirements (for registry generation)
          CATALOG_TITLE=$(yq eval '.metadata.annotations["toolhive.stacklok.dev/catalog-title"] // ""' "$FILE")
          CATALOG_TOOLS=$(yq eval '.metadata.annotations["toolhive.stacklok.dev/catalog-tools"] // ""' "$FILE")
          REPO_URL=$(yq eval '.metadata.annotations["toolhive.stacklok.dev/repository-url"] // ""' "$FILE")

          # Warn if catalog annotations missing (not fatal, but needed for catalog)
          WARNINGS=""
          if [ -z "$CATALOG_TITLE" ]; then
            WARNINGS="${WARNINGS}Missing annotation: toolhive.stacklok.dev/catalog-title\n"
          fi
          if [ -z "$CATALOG_TOOLS" ]; then
            WARNINGS="${WARNINGS}Missing annotation: toolhive.stacklok.dev/catalog-tools\n"
          fi
          if [ -z "$REPO_URL" ]; then
            WARNINGS="${WARNINGS}Missing annotation: toolhive.stacklok.dev/repository-url\n"
          fi

          if [ -n "$ERRORS" ]; then
            echo "::error::Validation failed for $FILE"
            echo -e "$ERRORS"
            exit 1
          fi

          if [ -n "$WARNINGS" ]; then
            echo "::warning::$FILE is missing catalog annotations - catalog entry may be incomplete"
            echo -e "$WARNINGS"
          fi

          echo "Validation passed for $FILE"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

      - name: Check for Hardcoded Secrets
        run: |
          FILE="${{ matrix.file }}"
          echo "Checking for hardcoded secrets in: $FILE"

          # Patterns that suggest hardcoded secrets
          PATTERNS=(
            "password:"
            "api_key:"
            "apiKey:"
            "secret:"
            "token:"
            "sk-"
            "Bearer "
          )

          FOUND=""
          for pattern in "${PATTERNS[@]}"; do
            # Check env values (not names or references to secrets)
            if yq eval '.spec.env[].value' "$FILE" 2>/dev/null | grep -qi "$pattern"; then
              FOUND="${FOUND}Potential secret pattern found: $pattern\n"
            fi
          done

          if [ -n "$FOUND" ]; then
            echo "::error::Potential hardcoded secrets detected in $FILE"
            echo -e "$FOUND"
            echo "Use spec.secrets with ExternalSecrets instead of hardcoding values"
            exit 1
          fi

          echo "No hardcoded secrets detected"

  # =============================================================================
  # Job 3: Security scan container images (optional but recommended)
  # =============================================================================
  image-scan:
    name: Scan Container Image
    needs: [preflight, validate]
    if: needs.preflight.outputs.mcpservers_changed == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJson(needs.preflight.outputs.mcpserver_files) }}
      fail-fast: false
    continue-on-error: true  # Don't block PR on scan failures, just warn
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install yq
        run: |
          # Download yq with checksum verification for supply chain security
          wget -qO /tmp/yq "https://github.com/mikefarah/yq/releases/download/v${{ env.YQ_VERSION }}/yq_linux_amd64"
          echo "${{ env.YQ_CHECKSUM }}  /tmp/yq" | sha256sum -c -
          sudo mv /tmp/yq /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Extract Image
        id: image
        run: |
          IMAGE=$(yq eval '.spec.image' "${{ matrix.file }}")
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"
          echo "Scanning image: $IMAGE"

      - name: Run Trivy Scan
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # v0.28.0
        with:
          image-ref: ${{ steps.image.outputs.image }}
          format: "table"
          exit-code: "0"  # Don't fail, just report
          severity: "HIGH,CRITICAL"
          ignore-unfixed: true

  # =============================================================================
  # Job 4: Generate Registry Catalog Entry
  # =============================================================================
  generate-catalog:
    name: Generate Catalog Entry
    needs: [preflight, validate]
    if: needs.preflight.outputs.mcpservers_changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write       # Required: Auto-commit registry.json changes to PR
      pull-requests: write  # Required: Add status comment to PR
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Install Tools
        run: |
          # Download yq with checksum verification for supply chain security
          wget -qO /tmp/yq "https://github.com/mikefarah/yq/releases/download/v${{ env.YQ_VERSION }}/yq_linux_amd64"
          echo "${{ env.YQ_CHECKSUM }}  /tmp/yq" | sha256sum -c -
          sudo mv /tmp/yq /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Generate Registry Entries
        id: generate
        run: |
          # Process all MCPServer files and generate registry.json
          REGISTRY_FILE="${{ env.REGISTRY_PATH }}"
          MCPSERVER_DIR="${{ env.MCPSERVER_PATH }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Start building servers array
          SERVERS="[]"

          for mcpfile in "$MCPSERVER_DIR"/mcpserver-*.yaml; do
            [ -f "$mcpfile" ] || continue

            echo "Processing: $mcpfile"

            # Extract metadata from MCPServer
            NAME=$(yq eval '.metadata.name' "$mcpfile")
            DESCRIPTION=$(yq eval '.metadata.annotations["toolhive.stacklok.dev/registry-description"] // "No description available"' "$mcpfile")
            TITLE=$(yq eval '.metadata.annotations["toolhive.stacklok.dev/catalog-title"] // .metadata.name' "$mcpfile")
            TOOLS_CSV=$(yq eval '.metadata.annotations["toolhive.stacklok.dev/catalog-tools"] // ""' "$mcpfile")
            TAGS_CSV=$(yq eval '.metadata.annotations["toolhive.stacklok.dev/catalog-tags"] // "homelab,mcp"' "$mcpfile")
            REPO_URL=$(yq eval '.metadata.annotations["toolhive.stacklok.dev/repository-url"] // ""' "$mcpfile")
            IMAGE=$(yq eval '.spec.image' "$mcpfile")

            # Derive repo source from URL
            if echo "$REPO_URL" | grep -q "github.com"; then
              REPO_SOURCE="github"
            elif echo "$REPO_URL" | grep -q "gitlab"; then
              REPO_SOURCE="gitlab"
            else
              REPO_SOURCE="other"
            fi

            # Convert CSV to JSON arrays
            TOOLS_JSON=$(echo "$TOOLS_CSV" | tr ',' '\n' | jq -R -s -c 'split("\n") | map(select(length > 0) | gsub("^\\s+|\\s+$"; ""))')
            TAGS_JSON=$(echo "$TAGS_CSV" | tr ',' '\n' | jq -R -s -c 'split("\n") | map(select(length > 0) | gsub("^\\s+|\\s+$"; ""))')

            # Build the endpoint URL
            ENDPOINT_URL="https://mcp.homelab0.org/servers/${NAME}/mcp"

            # Create server entry
            SERVER_ENTRY=$(jq -n \
              --arg schema "https://static.modelcontextprotocol.io/schemas/2025-09-29/server.schema.json" \
              --arg name "homelab/${NAME}-mcp" \
              --arg title "$TITLE" \
              --arg description "$DESCRIPTION" \
              --arg version "1.0.0" \
              --arg repo_url "$REPO_URL" \
              --arg repo_source "$REPO_SOURCE" \
              --arg endpoint "$ENDPOINT_URL" \
              --argjson tools "$TOOLS_JSON" \
              --argjson tags "$TAGS_JSON" \
              '{
                "$schema": $schema,
                "name": $name,
                "title": $title,
                "description": $description,
                "version": $version,
                "repository": {
                  "url": $repo_url,
                  "source": $repo_source
                },
                "remotes": [
                  {
                    "type": "streamable-http",
                    "url": $endpoint
                  }
                ],
                "_meta": {
                  "io.modelcontextprotocol.registry/publisher-provided": {
                    "homelab": {
                      ($endpoint): {
                        "status": "Active",
                        "tier": "Community",
                        "tags": $tags,
                        "tools": $tools
                      }
                    }
                  }
                }
              }')

            # Add to servers array
            SERVERS=$(echo "$SERVERS" | jq --argjson entry "$SERVER_ENTRY" '. += [$entry]')

            echo "  Added: homelab/${NAME}-mcp"
          done

          # Build final registry.json
          REGISTRY=$(jq -n \
            --arg schema "https://raw.githubusercontent.com/stacklok/toolhive-registry-server/main/internal/registry/upstream-registry.schema.json" \
            --arg timestamp "$TIMESTAMP" \
            --argjson servers "$SERVERS" \
            '{
              "$schema": $schema,
              "version": "1.0.0",
              "meta": {
                "last_updated": $timestamp
              },
              "data": {
                "servers": $servers
              }
            }')

          # Write registry.json
          echo "$REGISTRY" | jq '.' > "$REGISTRY_FILE"

          echo "Generated registry with $(echo "$SERVERS" | jq 'length') servers"
          echo "servers_count=$(echo "$SERVERS" | jq 'length')" >> "$GITHUB_OUTPUT"

      - name: Check for Changes
        id: check-changes
        run: |
          if git diff --quiet "${{ env.REGISTRY_PATH }}"; then
            echo "No changes to registry.json"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "Registry.json has been updated"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            git diff "${{ env.REGISTRY_PATH }}"
          fi

      - name: Generate GitHub App Token
        if: steps.check-changes.outputs.has_changes == 'true'
        id: generate-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}

      - name: Commit Catalog Changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add "${{ env.REGISTRY_PATH }}"
          git commit -m "chore(mcp): auto-generate registry catalog from MCPServer CRDs

          Generated ${{ steps.generate.outputs.servers_count }} catalog entries from MCPServer definitions.

          [skip ci]"
          git push

      - name: Comment on PR
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: mshick/add-pr-comment@b8f338c590a895d50bcbfa6c5859251edc8952fc # v2.8.2
        with:
          repo-token: ${{ steps.generate-token.outputs.token }}
          message-id: "mcp-catalog-sync"
          message: |
            ## :sparkles: MCP Catalog Updated

            The registry catalog has been automatically updated from MCPServer CRD definitions.

            | Metric | Value |
            |--------|-------|
            | Servers in catalog | ${{ steps.generate.outputs.servers_count }} |
            | Last updated | ${{ github.event.pull_request.head.sha }} |

            **Changes committed to this PR.** The catalog will be available after merge.

  # =============================================================================
  # Job 5: Status Check
  # =============================================================================
  mcp-catalog-status:
    name: MCP Catalog Sync Status
    needs: [preflight, validate, generate-catalog]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check Results
        run: |
          echo "Preflight: ${{ needs.preflight.result }}"
          echo "Validate: ${{ needs.validate.result }}"
          echo "Generate: ${{ needs.generate-catalog.result }}"

          # Only require validation to pass if MCPServers changed
          if [ "${{ needs.preflight.outputs.mcpservers_changed }}" = "true" ]; then
            if [ "${{ needs.validate.result }}" = "failure" ]; then
              echo "::error::MCPServer validation failed"
              exit 1
            fi
          fi

          echo "MCP Catalog Sync completed successfully"
