---
# Ceph Version Compatibility Check
# Ensures Rook/Ceph image version matches Proxmox Ceph cluster version
#
# This workflow prevents version mismatches between:
# - Rook CSI driver image (managed by Renovate, defined in cephcluster.yaml)
# - Actual Ceph cluster running on Proxmox
#
# For external Ceph clusters, the Rook image version should match the
# Proxmox Ceph version to ensure CSI driver compatibility.

name: Ceph Version Check

on:
  pull_request:
    paths:
      - 'kubernetes/apps/rook-ceph/rook-ceph-cluster/app/cephcluster.yaml'

env:
  # SSH configuration (StrictHostKeyChecking disabled for CI automation)
  SSH_OPTIONS: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10"

# Explicit permissions - principle of least privilege
permissions:
  contents: read
  pull-requests: read

jobs:
  check-ceph-version:
    name: Verify Ceph Version Compatibility
    runs-on: gha-runner-scale-set  # Self-hosted K8s runner with Proxmox network access
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup SSH key
        env:
          PROXMOX_SSH_KEY: ${{ secrets.PROXMOX_SSH_KEY }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Validate key is configured
          if [ -z "$PROXMOX_SSH_KEY" ]; then
            echo "::error::PROXMOX_SSH_KEY secret not configured"
            exit 1
          fi

          # Write key using printf (prevents heredoc injection)
          printf '%s\n' "$PROXMOX_SSH_KEY" > ~/.ssh/proxmox_key
          chmod 600 ~/.ssh/proxmox_key

          # Validate key format with ssh-keygen
          if ! ssh-keygen -l -f ~/.ssh/proxmox_key &>/dev/null; then
            echo "::error::PROXMOX_SSH_KEY is not a valid SSH key"
            rm -f ~/.ssh/proxmox_key
            exit 1
          fi

          # Ensure the key is a private key (ssh-keygen -y only works with private keys)
          if ! ssh-keygen -y -f ~/.ssh/proxmox_key >/dev/null 2>&1; then
            echo "::error::PROXMOX_SSH_KEY must be an SSH private key (a public key or invalid file was provided)"
            rm -f ~/.ssh/proxmox_key
            exit 1
          fi

          echo "‚úÖ SSH key configured"

      - name: Extract proposed Ceph version from PR
        id: proposed
        run: |
          set -euo pipefail
          # Extract version from cephcluster.yaml
          PROPOSED_IMAGE=$(grep -E '^\s*image:\s*quay\.io/ceph/ceph:' kubernetes/apps/rook-ceph/rook-ceph-cluster/app/cephcluster.yaml | awk '{print $2}')
          PROPOSED_VERSION=$(echo "$PROPOSED_IMAGE" | sed 's/.*:v\?//' | cut -d'.' -f1-2)
          PROPOSED_MAJOR=$(echo "$PROPOSED_VERSION" | cut -d'.' -f1)

          # Validate extraction succeeded
          if [ -z "$PROPOSED_IMAGE" ] || [ -z "$PROPOSED_MAJOR" ]; then
            echo "::error::Failed to extract Ceph version from cephcluster.yaml"
            echo "::error::Expected image pattern: quay.io/ceph/ceph:vX.Y.Z"
            exit 1
          fi

          echo "image=$PROPOSED_IMAGE" >> $GITHUB_OUTPUT
          echo "version=$PROPOSED_VERSION" >> $GITHUB_OUTPUT
          echo "major=$PROPOSED_MAJOR" >> $GITHUB_OUTPUT

          echo "üì¶ Proposed Ceph image: $PROPOSED_IMAGE"
          echo "üì¶ Proposed version: $PROPOSED_VERSION (major: $PROPOSED_MAJOR)"

      - name: Find available Proxmox node
        id: find_host
        env:
          HOST1: ${{ secrets.PROXMOX_CEPH_HOST1 }}
          HOST2: ${{ secrets.PROXMOX_CEPH_HOST2 }}
          HOST3: ${{ secrets.PROXMOX_CEPH_HOST3 }}
          HOST4: ${{ secrets.PROXMOX_CEPH_HOST4 }}
        run: |
          set -euo pipefail

          # Collect configured hosts
          HOSTS=()
          for host in "$HOST1" "$HOST2" "$HOST3" "$HOST4"; do
            if [ -n "$host" ]; then
              HOSTS+=("$host")
            fi
          done

          if [ ${#HOSTS[@]} -eq 0 ]; then
            echo "::error::No PROXMOX_CEPH_HOST secrets configured"
            echo "::error::Add at least one of: PROXMOX_CEPH_HOST1, PROXMOX_CEPH_HOST2, PROXMOX_CEPH_HOST3, PROXMOX_CEPH_HOST4"
            exit 1
          fi

          echo "üîç Testing connectivity to ${#HOSTS[@]} Proxmox node(s)..."

          # Shuffle hosts for load distribution (mapfile avoids word-splitting issues)
          mapfile -t SHUFFLED < <(printf '%s\n' "${HOSTS[@]}" | shuf)

          # Find first responding host
          SELECTED_HOST=""
          for host in "${SHUFFLED[@]}"; do
            # Validate host format: hostname (RFC1123) or IPv4 address (prevent command injection)
            # IPv4 regex enforces valid octets (0-255)
            if ! echo "$host" | grep -qE '^([a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?)*|(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])(\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])){3})$'; then
              echo "‚ö†Ô∏è Skipping invalid host format: [redacted]"
              continue
            fi
            if echo "$host" | grep -qE "[;&|$\`\"'<>(){}]"; then
              echo "‚ö†Ô∏è Skipping host with disallowed characters: [redacted]"
              continue
            fi

            echo "  Testing $host..."
            if ssh "${{ env.SSH_OPTIONS }}" -i ~/.ssh/proxmox_key "root@${host}" "echo ok" &>/dev/null; then
              SELECTED_HOST="$host"
              echo "‚úÖ Selected: $host"
              break
            else
              echo "  ‚ùå $host not reachable"
            fi
          done

          if [ -z "$SELECTED_HOST" ]; then
            echo "::error::No Proxmox nodes are reachable"
            exit 1
          fi

          echo "host=$SELECTED_HOST" >> $GITHUB_OUTPUT

      - name: Query Proxmox Ceph version
        id: proxmox
        run: |
          set -euo pipefail
          PROXMOX_HOST="${{ steps.find_host.outputs.host }}"

          echo "üîç Querying Ceph version from Proxmox node..."

          # Query Ceph version via SSH
          # Note: root is required for ceph CLI access; username hardcoded to prevent injection
          CEPH_OUTPUT=$(ssh "${{ env.SSH_OPTIONS }}" -i ~/.ssh/proxmox_key "root@${PROXMOX_HOST}" "ceph version" 2>/dev/null) || {
            echo "::error::Failed to query Ceph version from $PROXMOX_HOST"
            exit 1
          }

          echo "üì° Ceph version output: $CEPH_OUTPUT"

          # Parse version (format: "ceph version 19.2.3 (hash) squid (stable)")
          # Using sed for POSIX compatibility (avoids grep -P which requires PCRE)
          PROXMOX_VERSION=$(echo "$CEPH_OUTPUT" | sed -n 's/.*ceph version \([0-9]\+\.[0-9]\+\).*/\1/p')
          PROXMOX_MAJOR=$(echo "$PROXMOX_VERSION" | cut -d'.' -f1)
          PROXMOX_CODENAME=$(echo "$CEPH_OUTPUT" | sed -n 's/.*) \([a-z]\+\).*/\1/p' | head -1)

          # Validate parsing succeeded
          if [ -z "$PROXMOX_VERSION" ] || [ -z "$PROXMOX_MAJOR" ]; then
            echo "::error::Failed to parse Ceph version from output: $CEPH_OUTPUT"
            exit 1
          fi

          echo "version=$PROXMOX_VERSION" >> $GITHUB_OUTPUT
          echo "major=$PROXMOX_MAJOR" >> $GITHUB_OUTPUT
          echo "codename=$PROXMOX_CODENAME" >> $GITHUB_OUTPUT

          echo "üñ•Ô∏è Proxmox Ceph version: $PROXMOX_VERSION (major: $PROXMOX_MAJOR, codename: $PROXMOX_CODENAME)"

      - name: Compare versions
        id: compare
        run: |
          set -euo pipefail
          PROPOSED_MAJOR="${{ steps.proposed.outputs.major }}"
          PROXMOX_MAJOR="${{ steps.proxmox.outputs.major }}"
          PROXMOX_CODENAME="${{ steps.proxmox.outputs.codename }}"

          # Validate major versions are numeric
          if ! [[ "$PROPOSED_MAJOR" =~ ^[0-9]+$ ]] || ! [[ "$PROXMOX_MAJOR" =~ ^[0-9]+$ ]]; then
            echo "::error::Invalid major version format (proposed: $PROPOSED_MAJOR, proxmox: $PROXMOX_MAJOR)"
            exit 1
          fi

          echo "=============================================="
          echo "       Ceph Version Compatibility Check       "
          echo "=============================================="
          echo ""
          echo "üì¶ Proposed (Rook/CSI):  v${{ steps.proposed.outputs.version }} (major: $PROPOSED_MAJOR)"
          echo "üñ•Ô∏è Proxmox (Cluster):    v${{ steps.proxmox.outputs.version }} ($PROXMOX_CODENAME, major: $PROXMOX_MAJOR)"
          echo ""

          if [ "$PROPOSED_MAJOR" = "$PROXMOX_MAJOR" ]; then
            echo "‚úÖ Version compatible: Both are major version $PROPOSED_MAJOR"
            echo "status=compatible" >> $GITHUB_OUTPUT
          elif [ "$PROPOSED_MAJOR" -gt "$PROXMOX_MAJOR" ]; then
            echo "::error::‚ùå Version INCOMPATIBLE"
            echo "::error::Proposed Rook image (v$PROPOSED_MAJOR) is NEWER than Proxmox Ceph (v$PROXMOX_MAJOR)"
            echo "::error::"
            echo "::error::You must upgrade Ceph on Proxmox FIRST before updating the Rook image."
            echo "::error::See: https://pve.proxmox.com/wiki/Ceph_Reef_to_Squid"
            echo ""
            echo "status=incompatible" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "‚ö†Ô∏è Warning: Proposed version (v$PROPOSED_MAJOR) is OLDER than Proxmox (v$PROXMOX_MAJOR)"
            echo "‚ö†Ô∏è This should work but consider updating to match Proxmox version"
            echo "status=older" >> $GITHUB_OUTPUT
          fi

      - name: Post result summary
        if: always()
        run: |
          # Use fallback values if earlier steps failed
          PROPOSED_VERSION="${{ steps.proposed.outputs.version }}"
          PROPOSED_MAJOR="${{ steps.proposed.outputs.major }}"
          PROXMOX_VERSION="${{ steps.proxmox.outputs.version }}"
          PROXMOX_MAJOR="${{ steps.proxmox.outputs.major }}"
          PROXMOX_CODENAME="${{ steps.proxmox.outputs.codename }}"
          STATUS="${{ steps.compare.outputs.status }}"

          # Apply defaults for empty values
          PROPOSED_VERSION="${PROPOSED_VERSION:-N/A}"
          PROPOSED_MAJOR="${PROPOSED_MAJOR:-N/A}"
          PROXMOX_VERSION="${PROXMOX_VERSION:-N/A}"
          PROXMOX_MAJOR="${PROXMOX_MAJOR:-N/A}"
          PROXMOX_CODENAME="${PROXMOX_CODENAME:-N/A}"
          STATUS="${STATUS:-unknown}"

          echo "## Ceph Version Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Version | Major |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Proposed (Rook/CSI) | v${PROPOSED_VERSION} | ${PROPOSED_MAJOR} |" >> $GITHUB_STEP_SUMMARY
          echo "| Proxmox (Cluster) | v${PROXMOX_VERSION} (${PROXMOX_CODENAME}) | ${PROXMOX_MAJOR} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$STATUS" = "compatible" ]; then
            echo "### ‚úÖ Compatible" >> $GITHUB_STEP_SUMMARY
            echo "Both versions are major version ${PROPOSED_MAJOR}. Safe to merge." >> $GITHUB_STEP_SUMMARY
          elif [ "$STATUS" = "incompatible" ]; then
            echo "### ‚ùå Incompatible" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:** Upgrade Ceph on Proxmox to v${PROPOSED_MAJOR} before merging this PR." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See: [Proxmox Ceph Upgrade Guide](https://pve.proxmox.com/wiki/Ceph_Reef_to_Squid)" >> $GITHUB_STEP_SUMMARY
          elif [ "$STATUS" = "older" ]; then
            echo "### ‚ö†Ô∏è Older Version" >> $GITHUB_STEP_SUMMARY
            echo "Proposed version is older than Proxmox. This should work but consider updating." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ÑπÔ∏è Status Unknown" >> $GITHUB_STEP_SUMMARY
            echo "Version comparison did not complete. Check workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup SSH credentials
        if: always()
        run: |
          rm -f ~/.ssh/proxmox_key
          echo "üßπ SSH credentials cleaned up"
