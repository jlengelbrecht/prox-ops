{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "customManagers": [
    {
      "customType": "regex",
      // Process annotated dependencies in non-Kubernetes YAML files
      // NOTE: kubernetes/ files are handled by built-in managers (flux, helm-values, kubernetes)
      // This custom manager only targets files that built-in managers don't process
      "description": "Process annotated dependencies in Talos and template files",
      "managerFilePatterns": [
        "/^talos/talenv\\.yaml$/",
        "/^templates/.+\\.ya?ml(\\.j2)?$/"
      ],
      "matchStrings": [
        "# renovate: datasource=(?<datasource>\\S+) depName=(?<depName>\\S+)( versioning=(?<versioning>\\S+))?\\n(?:\\s*\\w+:\\s*|\\s*)\"?(?<currentValue>[^\\s\"]+)\"?"
      ],
      "datasourceTemplate": "{{#if datasource}}{{{datasource}}}{{else}}github-releases{{/if}}",
      "versioningTemplate": "{{#if versioning}}{{{versioning}}}{{else}}semver{{/if}}"
    },
    {
      "customType": "regex",
      "description": "Monitor Talos version in Terraform variables and tfvars",
      "managerFilePatterns": ["/^terraform/variables\\.tf$/", "/^terraform/terraform\\.tfvars$/"],
      "matchStrings": [
        "variable\\s+\"talos_version\"\\s*\\{[\\s\\S]*?default\\s*=\\s*\"(?<currentValue>\\d+\\.\\d+\\.\\d+)\"",
        "talos_version\\s*=\\s*\"(?<currentValue>\\d+\\.\\d+\\.\\d+)\""
      ],
      "datasourceTemplate": "github-releases",
      "depNameTemplate": "siderolabs/talos",
      "versioningTemplate": "semver"
    },
    {
      "customType": "regex",
      "description": "Monitor Terraform version in GitHub Actions workflows",
      "managerFilePatterns": ["/^\\.github/workflows/.+\\.ya?ml$/"],
      "matchStrings": [
        // YAML env format: TERRAFORM_VERSION: "1.11.3"
        "TERRAFORM_VERSION:\\s*\"(?<currentValue>\\d+\\.\\d+\\.\\d+)\"",
        // Bash assignment format: TERRAFORM_VERSION="1.11.3"
        "TERRAFORM_VERSION=\"(?<currentValue>\\d+\\.\\d+\\.\\d+)\""
      ],
      "datasourceTemplate": "github-releases",
      "depNameTemplate": "hashicorp/terraform",
      "versioningTemplate": "semver"
    },
    {
      "customType": "regex",
      "description": "Monitor Gitleaks version in GitHub Actions workflows",
      "managerFilePatterns": ["/^\\.github/workflows/.+\\.ya?ml$/"],
      "matchStrings": [
        // Matches: # renovate: datasource=github-releases depName=gitleaks/gitleaks
        //          GITLEAKS_VERSION: "8.21.2"
        "# renovate: datasource=github-releases depName=gitleaks/gitleaks\\n\\s*GITLEAKS_VERSION:\\s*\"(?<currentValue>\\d+\\.\\d+\\.\\d+)\""
      ],
      "datasourceTemplate": "github-releases",
      "depNameTemplate": "gitleaks/gitleaks",
      "versioningTemplate": "semver"
    },
    {
      "customType": "regex",
      "description": "Monitor ensure-sops version in GitHub Actions workflows",
      "managerFilePatterns": ["/^\\.github/workflows/.+\\.ya?ml$/"],
      "matchStrings": [
        // Matches: # renovate: datasource=pypi depName=ensure-sops
        //          ENSURE_SOPS_VERSION: "0.1.2"
        "# renovate: datasource=pypi depName=ensure-sops\\n\\s*ENSURE_SOPS_VERSION:\\s*\"(?<currentValue>[^\"]+)\""
      ],
      "datasourceTemplate": "pypi",
      "depNameTemplate": "ensure-sops",
      "versioningTemplate": "pep440"
    },
    {
      "customType": "regex",
      "description": "Track Docker container images in GitHub Actions (docker:// syntax)",
      "managerFilePatterns": ["/^\\.github/workflows/.+\\.ya?ml$/"],
      "matchStrings": [
        "uses:\\s*docker://(?<depName>[^:]+):(?<currentValue>[^\\s\"]+)"
      ],
      "datasourceTemplate": "docker",
      "versioningTemplate": "semver"
    },
    {
      "customType": "regex",
      "description": "Track OCI artifact versions in Flux HelmReleases",
      "managerFilePatterns": [
        "/(^|/)kubernetes/.+\\.ya?ml$/"
      ],
      "matchStrings": [
        // Matches: # renovate: datasource=docker depName=ghcr.io/foo/bar
        //          artifact: oci://ghcr.io/foo/bar:v1.2.3
        "# renovate: datasource=(?<datasource>\\S+) depName=(?<depName>\\S+)\\n\\s*artifact:\\s*oci://[^:]+:(?<currentValue>[^\\s\"]+)"
      ],
      "datasourceTemplate": "{{#if datasource}}{{{datasource}}}{{else}}docker{{/if}}",
      "versioningTemplate": "docker"
    },
    // =========================================================================
    // MCP Source Package Managers (for CI/CD container building)
    // =========================================================================
    // These managers track # mcp-source: comments in MCPServer manifests.
    // When Renovate updates the version, CI/CD detects the mismatch between
    // mcp-source version and spec.image version, then builds a new container.
    // =========================================================================
    {
      "customType": "regex",
      "description": "Track PyPI packages in MCP source comments (uvx://)",
      "managerFilePatterns": [
        "/(^|/)kubernetes/apps/mcp/.+\\.ya?ml$/"
      ],
      "matchStrings": [
        // Matches: # renovate: datasource=pypi depName=truenas-mcp-server versioning=pep440
        //          # mcp-source: uvx://truenas-mcp-server@3.0.2
        // Note: \\s* at start handles YAML indentation
        "\\s*# renovate: datasource=pypi depName=(?<depName>\\S+)(?: versioning=(?<versioning>\\S+))?\\n\\s*# mcp-source:\\s*uvx://[^@]+@(?<currentValue>[^\\s]+)"
      ],
      "datasourceTemplate": "pypi",
      "versioningTemplate": "{{#if versioning}}{{{versioning}}}{{else}}pep440{{/if}}"
    },
    {
      "customType": "regex",
      "description": "Track npm packages in MCP source comments (npx://)",
      "managerFilePatterns": [
        "/(^|/)kubernetes/apps/mcp/.+\\.ya?ml$/"
      ],
      "matchStrings": [
        // Matches: # renovate: datasource=npm depName=@modelcontextprotocol/server-filesystem
        //          # mcp-source: npx://@modelcontextprotocol/server-filesystem@1.0.0
        // Note: Uses [^\\s]+@ to support scoped packages (regex backtracks to find last @)
        // Note: \\s* at start handles YAML indentation
        "\\s*# renovate: datasource=npm depName=(?<depName>\\S+)(?: versioning=(?<versioning>\\S+))?\\n\\s*# mcp-source:\\s*npx://[^\\s]+@(?<currentValue>[^\\s]+)"
      ],
      "datasourceTemplate": "npm",
      "versioningTemplate": "{{#if versioning}}{{{versioning}}}{{else}}npm{{/if}}"
    },
    {
      "customType": "regex",
      "description": "Track Go modules in MCP source comments (go://)",
      "managerFilePatterns": [
        "/(^|/)kubernetes/apps/mcp/.+\\.ya?ml$/"
      ],
      "matchStrings": [
        // Matches: # renovate: datasource=go depName=github.com/user/repo
        //          # mcp-source: go://github.com/user/repo@v1.0.0
        // Note: \\s* at start handles YAML indentation
        "\\s*# renovate: datasource=go depName=(?<depName>\\S+)(?: versioning=(?<versioning>\\S+))?\\n\\s*# mcp-source:\\s*go://[^@]+@(?<currentValue>[^\\s]+)"
      ],
      "datasourceTemplate": "go",
      "versioningTemplate": "{{#if versioning}}{{{versioning}}}{{else}}semver{{/if}}"
    },
    {
      "customType": "regex",
      "description": "Track GitHub releases in MCP source comments (github://)",
      "managerFilePatterns": [
        "/(^|/)kubernetes/apps/mcp/.+\\.ya?ml$/"
      ],
      "matchStrings": [
        // Matches: # renovate: datasource=github-releases depName=user/repo
        //          # mcp-source: github://user/repo@v1.0.0
        // Note: \\s* at start handles YAML indentation
        "\\s*# renovate: datasource=github-releases depName=(?<depName>\\S+)(?: versioning=(?<versioning>\\S+))?\\n\\s*# mcp-source:\\s*github://[^@]+@(?<currentValue>[^\\s]+)"
      ],
      "datasourceTemplate": "github-releases",
      "versioningTemplate": "{{#if versioning}}{{{versioning}}}{{else}}semver{{/if}}"
    }
  ]
}
